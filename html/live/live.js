Object.keys||(Object.keys=function(){var b=Object.prototype.hasOwnProperty,f=!{toString:null}.propertyIsEnumerable("toString"),h="toString toLocaleString valueOf hasOwnProperty isPrototypeOf propertyIsEnumerable constructor".split(" "),q=h.length;return function(u){if("object"!==typeof u&&("function"!==typeof u||null===u))throw new TypeError("Object.keys called on non-object");var v=[],x;for(x in u)b.call(u,x)&&v.push(x);if(f)for(x=0;x<q;x++)b.call(u,h[x])&&v.push(h[x]);return v}}());
Array.prototype.forEach||(Array.prototype.forEach=function(b){if(void 0===this||null===this)throw new TypeError;var f=Object(this),h=f.length>>>0;if("function"!==typeof b)throw new TypeError;for(var q=2<=arguments.length?arguments[1]:void 0,u=0;u<h;u++)u in f&&b.call(q,f[u],u,f)});Ext.override(Date,{toUTC:function(){return this.add(Date.MINUTE,this.getTimezoneOffset())},fromUTC:function(){return this.add(Date.MINUTE,-this.getTimezoneOffset())}});
Ext.override(Ext.Panel,{setIconCls:function(b){Ext.fly(this.ownerCt.getTabEl(this)).child(".x-tab-strip-text").replaceClass(this.iconCls,b);this.setIconClass(b)}});
Ext.override(Ext.Element,{printCSS:null,printStyle:!1,printTitle:document.title,print:function(b){Ext.apply(this,b);b=Ext.get(this.id).dom;this.isGrid&&(b=b.parentNode);var f=document.getElementById("printcontainer"),h=document.getElementById("printframe"),q="";f&&(h&&f.removeChild(h),b.removeChild(f));for(h=0;h<b.attributes.length;h++)if(Ext.isEmpty(b.attributes[h].value)||"null"!=b.attributes[h].value.toLowerCase())if(f=Ext.isEmpty(b.attributes[h].value)?'{0}="true" ':'{0}="{1}" ',this.printStyle||
"style"!=b.attributes[h].name.toLowerCase())q+=String.format(f,b.attributes[h].name,b.attributes[h].value);f="";if(this.printCSS)for(Ext.isArray(this.printCSS)||(this.printCSS=[this.printCSS]),h=0;h<this.printCSS.length;h++)f+=String.format('<link rel="stylesheet" type="text/css" href="{0}"/>',this.printCSS[h]);q=String.format('<HTML><HEAD>{0}<TITLE>{1}</TITLE></HEAD><BODY onload="{2}"><DIV {3}>{4}</DIV></BODY></HTML>',f,this.printTitle,"",q,b.innerHTML);f=document.createElement("div");f.setAttribute("style",
"width:0px;height:0px;"+(Ext.isSafari?"display:none;":"visibility:hidden;"));f.setAttribute("id","printcontainer");b.appendChild(f);Ext.isIE&&(f.style.display="none");h=document.createElement("iframe");h.setAttribute("id","printframe");h.setAttribute("name","printframe");f.appendChild(h);h.contentWindow.document.open();h.contentWindow.document.write(q);h.contentWindow.document.close();this.isGrid&&(b=Ext.get(h.contentWindow.document.body),b=Ext.get(b.first().dom.parentNode),b.child("div.x-panel-body").setStyle("height",
""),b.child("div.x-grid3").setStyle("height",""),b.child("div.x-grid3-scroller").setStyle("height",""));Ext.isIE?h.contentWindow.document.execCommand("print"):h.contentWindow.print()}});!function(b,f){"object"==typeof exports&&"undefined"!=typeof module?f(exports):"function"==typeof define&&define.amd?define(["exports"],f):f((b="undefined"!=typeof globalThis?globalThis:b||self).strophe={})}(this,function(b){function f(){if("undefined"==typeof document)try{return(new (0,require("@xmldom/xmldom").DOMImplementation)).createDocument("jabber:client","strophe",null)}catch(d){throw Error('You must install the "@xmldom/xmldom" package to use Strophe in nodejs.');}if(void 0===document.implementation.createDocument||
document.implementation.createDocument&&document.documentMode&&10>document.documentMode){a:{const d="Msxml2.DOMDocument.6.0 Msxml2.DOMDocument.5.0 Msxml2.DOMDocument.4.0 MSXML2.DOMDocument.3.0 MSXML2.DOMDocument MSXML.DOMDocument Microsoft.XMLDOM".split(" ");for(let e=0;e<d.length;e++)try{var a=new ActiveXObject(d[e]);break a}catch(k){}a=void 0}return a.appendChild(a.createElement("strophe")),a}return document.implementation.createDocument("jabber:client","strophe",null)}function h(a,d){a[d>>5]|=
128<<24-d%32;a[15+(d+64>>9<<4)]=d;var e,k=Array(80),p=1732584193,l=-271733879,m=-1732584194,n=271733878,r=-1009589776;for(d=0;d<a.length;d+=16){var w=p;var P=l;var R=m;var W=n;var X=r;for(e=0;80>e;e++){var S=e;if(16>e)var M=a[d+e];else M=k[e-3]^k[e-8]^k[e-14]^k[e-16],M=M<<1|M>>>31;k[S]=M;S=u(u(p<<5|p>>>27,20>e?l&m|~l&n:40>e?l^m^n:60>e?l&m|l&n|m&n:l^m^n),u(u(r,k[e]),20>e?1518500249:40>e?1859775393:60>e?-1894007588:-899497514));r=n;n=m;m=l<<30|l>>>2;l=p;p=S}p=u(p,w);l=u(l,P);m=u(m,R);n=u(n,W);r=u(r,
X)}return[p,l,m,n,r]}function q(a,d){var e=v(a);16<e.length&&(e=h(e,8*a.length));var k=Array(16);a=Array(16);for(var p=0;16>p;p++)k[p]=909522486^e[p],a[p]=1549556828^e[p];d=h(k.concat(v(d)),512+8*d.length);return h(a.concat(d),672)}function u(a,d){var e=(65535&a)+(65535&d);return(a>>16)+(d>>16)+(e>>16)<<16|65535&e}function v(a){for(var d=[],e=0;e<8*a.length;e+=8)d[e>>5]|=(255&a.charCodeAt(e/8))<<24-e%32;return d}function x(a){for(var d,e,k="",p=0;p<4*a.length;p+=3)for(d=(a[p>>2]>>8*(3-p%4)&255)<<
16|(a[p+1>>2]>>8*(3-(p+1)%4)&255)<<8|a[p+2>>2]>>8*(3-(p+2)%4)&255,e=0;4>e;e++)8*p+6*e>32*a.length?k+="=":k+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(d>>6*(3-e)&63);return k}function y(a){for(var d="",e=0;e<32*a.length;e+=8)d+=String.fromCharCode(a[e>>5]>>>24-e%32&255);return d}function z(a,d){return new g.Builder(a,d)}function N(a){return new g.Builder("message",a)}function F(a){return new g.Builder("iq",a)}function G(a){return new g.Builder("presence",a)}var J="undefined"!=
typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{};const T=function(){let a=J.WebSocket;if(void 0===a)try{a=require("ws")}catch(d){throw Error('You must install the "ws" package to use Strophe in nodejs.');}return a}(),H=function(){let a=J.DOMParser;if(void 0===a)try{a=require("@xmldom/xmldom").DOMParser}catch(d){throw Error('You must install the "@xmldom/xmldom" package to use Strophe in nodejs.');}return a}(),I=function(a,d){const e=(65535&a)+(65535&d);return(a>>
16)+(d>>16)+(e>>16)<<16|65535&e},U=function(a){if("string"!=typeof a)throw Error("str2binl was passed a non-string");const d=[];for(let e=0;e<8*a.length;e+=8)d[e>>5]|=(255&a.charCodeAt(e/8))<<e%32;return d},A=function(a,d,e,k,p,l){return I((m=I(I(d,a),I(k,l)))<<(n=p)|m>>>32-n,e);var m,n},B=function(a,d,e,k,p,l,m){return A(d&e|~d&k,a,d,p,l,m)},C=function(a,d,e,k,p,l,m){return A(d&k|e&~k,a,d,p,l,m)},D=function(a,d,e,k,p,l,m){return A(e^(d|~k),a,d,p,l,m)},V=function(a,d){a[d>>5]|=128<<d%32;a[14+(d+64>>>
9<<4)]=d;let e,k,p,l=1732584193,m=-271733879,n=-1732584194,r=271733878;for(let w=0;w<a.length;w+=16)d=l,e=m,k=n,p=r,l=B(l,m,n,r,a[w+0],7,-680876936),r=B(r,l,m,n,a[w+1],12,-389564586),n=B(n,r,l,m,a[w+2],17,606105819),m=B(m,n,r,l,a[w+3],22,-1044525330),l=B(l,m,n,r,a[w+4],7,-176418897),r=B(r,l,m,n,a[w+5],12,1200080426),n=B(n,r,l,m,a[w+6],17,-1473231341),m=B(m,n,r,l,a[w+7],22,-45705983),l=B(l,m,n,r,a[w+8],7,1770035416),r=B(r,l,m,n,a[w+9],12,-1958414417),n=B(n,r,l,m,a[w+10],17,-42063),m=B(m,n,r,l,a[w+
11],22,-1990404162),l=B(l,m,n,r,a[w+12],7,1804603682),r=B(r,l,m,n,a[w+13],12,-40341101),n=B(n,r,l,m,a[w+14],17,-1502002290),m=B(m,n,r,l,a[w+15],22,1236535329),l=C(l,m,n,r,a[w+1],5,-165796510),r=C(r,l,m,n,a[w+6],9,-1069501632),n=C(n,r,l,m,a[w+11],14,643717713),m=C(m,n,r,l,a[w+0],20,-373897302),l=C(l,m,n,r,a[w+5],5,-701558691),r=C(r,l,m,n,a[w+10],9,38016083),n=C(n,r,l,m,a[w+15],14,-660478335),m=C(m,n,r,l,a[w+4],20,-405537848),l=C(l,m,n,r,a[w+9],5,568446438),r=C(r,l,m,n,a[w+14],9,-1019803690),n=C(n,
r,l,m,a[w+3],14,-187363961),m=C(m,n,r,l,a[w+8],20,1163531501),l=C(l,m,n,r,a[w+13],5,-1444681467),r=C(r,l,m,n,a[w+2],9,-51403784),n=C(n,r,l,m,a[w+7],14,1735328473),m=C(m,n,r,l,a[w+12],20,-1926607734),l=A(m^n^r,l,m,a[w+5],4,-378558),r=A(l^m^n,r,l,a[w+8],11,-2022574463),n=A(r^l^m,n,r,a[w+11],16,1839030562),m=A(n^r^l,m,n,a[w+14],23,-35309556),l=A(m^n^r,l,m,a[w+1],4,-1530992060),r=A(l^m^n,r,l,a[w+4],11,1272893353),n=A(r^l^m,n,r,a[w+7],16,-155497632),m=A(n^r^l,m,n,a[w+10],23,-1094730640),l=A(m^n^r,l,m,
a[w+13],4,681279174),r=A(l^m^n,r,l,a[w+0],11,-358537222),n=A(r^l^m,n,r,a[w+3],16,-722521979),m=A(n^r^l,m,n,a[w+6],23,76029189),l=A(m^n^r,l,m,a[w+9],4,-640364487),r=A(l^m^n,r,l,a[w+12],11,-421815835),n=A(r^l^m,n,r,a[w+15],16,530742520),m=A(n^r^l,m,n,a[w+2],23,-995338651),l=D(l,m,n,r,a[w+0],6,-198630844),r=D(r,l,m,n,a[w+7],10,1126891415),n=D(n,r,l,m,a[w+14],15,-1416354905),m=D(m,n,r,l,a[w+5],21,-57434055),l=D(l,m,n,r,a[w+12],6,1700485571),r=D(r,l,m,n,a[w+3],10,-1894986606),n=D(n,r,l,m,a[w+10],15,-1051523),
m=D(m,n,r,l,a[w+1],21,-2054922799),l=D(l,m,n,r,a[w+8],6,1873313359),r=D(r,l,m,n,a[w+15],10,-30611744),n=D(n,r,l,m,a[w+6],15,-1560198380),m=D(m,n,r,l,a[w+13],21,1309151649),l=D(l,m,n,r,a[w+4],6,-145523070),r=D(r,l,m,n,a[w+11],10,-1120210379),n=D(n,r,l,m,a[w+2],15,718787259),m=D(m,n,r,l,a[w+9],21,-343485551),l=I(l,d),m=I(m,e),n=I(n,k),r=I(r,p);return[l,m,n,r]},Y={hexdigest:function(a){a=V(U(a),8*a.length);let d="";for(let e=0;e<4*a.length;e++)d+="0123456789abcdef".charAt(a[e>>2]>>e%4*8+4&15)+"0123456789abcdef".charAt(a[e>>
2]>>e%4*8&15);return d},hash:function(a){a=V(U(a),8*a.length);let d="";for(let e=0;e<32*a.length;e+=8)d+=String.fromCharCode(a[e>>5]>>>e%32&255);return d}};class K{constructor(a,d,e){this.mechname=a;this.isClientFirst=d;this.priority=e}test(){return!0}onStart(a){this._connection=a}onChallenge(a,d){throw Error("You should implement challenge handling!");}clientChallenge(a){if(!this.isClientFirst)throw Error("clientChallenge should not be called if isClientFirst is false!");return this.onChallenge(a)}onFailure(){this._connection=
null}onSuccess(){this._connection=null}}const O=function(a){var d,e,k="",p=a.length;for(d=0;d<p;d++)0<=(e=a.charCodeAt(d))&&127>=e?k+=a.charAt(d):2047<e?(k+=String.fromCharCode(224|e>>12&15),k+=String.fromCharCode(128|e>>6&63),k+=String.fromCharCode(128|e>>0&63)):(k+=String.fromCharCode(192|e>>6&31),k+=String.fromCharCode(128|e>>0&63));return k},Z=function(a){a=a||{};for(const d in a)if(Object.prototype.hasOwnProperty.call(a,d)){let e="",k="",p="";const l=a[d],m="object"==typeof l,n=escape(unescape(m?
l.value:l));m&&(e=l.expires?";expires="+l.expires:"",k=l.domain?";domain="+l.domain:"",p=l.path?";path="+l.path:"");document.cookie=d+"="+n+e+k+p}},E={b64_hmac_sha1:function(a,d){return x(q(a,d))},b64_sha1:function(a){return x(h(v(a),8*a.length))},binb2str:y,core_hmac_sha1:q,str_hmac_sha1:function(a,d){return y(q(a,d))},str_sha1:function(a){return y(h(v(a),8*a.length))}};var Q={atob:function(a){if(0===arguments.length)throw new TypeError("1 argument required, but only 0 present.");if(0==(a=(a=`${a}`).replace(/[ \t\n\f\r]/g,
"")).length%4&&(a=a.replace(/==?$/,"")),1==a.length%4||/[^+/0-9A-Za-z]/.test(a))return null;let d="";var e=0;let k=0;for(let p=0;p<a.length;p++){e<<=6;const l="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".indexOf(a[p]);e|=0>l?NaN:l;k+=6;24===k&&(d+=String.fromCharCode((16711680&e)>>16),d+=String.fromCharCode((65280&e)>>8),d+=String.fromCharCode(255&e),e=k=0)}return 12===k?(e>>=4,d+=String.fromCharCode(e)):18===k&&(e>>=2,d+=String.fromCharCode((65280&e)>>8),d+=String.fromCharCode(255&
e)),d},btoa:function(a){if(0===arguments.length)throw new TypeError("1 argument required, but only 0 present.");let d;a=`${a}`;for(d=0;d<a.length;d++)if(255<a.charCodeAt(d))return null;var e="";for(d=0;d<a.length;d+=3){const p=[void 0,void 0,void 0,void 0];p[0]=a.charCodeAt(d)>>2;p[1]=(3&a.charCodeAt(d))<<4;a.length>d+1&&(p[1]|=a.charCodeAt(d+1)>>4,p[2]=(15&a.charCodeAt(d+1))<<2);a.length>d+2&&(p[2]|=a.charCodeAt(d+2)>>6,p[3]=63&a.charCodeAt(d+2));for(let l=0;l<p.length;l++)if(void 0===p[l])e+="=";
else{var k=p[l];k=0<=k&&64>k?"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[k]:void 0;e+=k}}return e}};const g={VERSION:"1.5.0",NS:{HTTPBIND:"http://jabber.org/protocol/httpbind",BOSH:"urn:xmpp:xbosh",CLIENT:"jabber:client",AUTH:"jabber:iq:auth",ROSTER:"jabber:iq:roster",PROFILE:"jabber:iq:profile",DISCO_INFO:"http://jabber.org/protocol/disco#info",DISCO_ITEMS:"http://jabber.org/protocol/disco#items",MUC:"http://jabber.org/protocol/muc",SASL:"urn:ietf:params:xml:ns:xmpp-sasl",
STREAM:"http://etherx.jabber.org/streams",FRAMING:"urn:ietf:params:xml:ns:xmpp-framing",BIND:"urn:ietf:params:xml:ns:xmpp-bind",SESSION:"urn:ietf:params:xml:ns:xmpp-session",VERSION:"jabber:iq:version",STANZAS:"urn:ietf:params:xml:ns:xmpp-stanzas",XHTML_IM:"http://jabber.org/protocol/xhtml-im",XHTML:"http://www.w3.org/1999/xhtml"},XHTML:{tags:"a blockquote br cite em img li ol p span strong ul body".split(" "),attributes:{a:["href"],blockquote:["style"],br:[],cite:["style"],em:[],img:["src","alt",
"style","height","width"],li:["style"],ol:["style"],p:["style"],span:["style"],strong:[],ul:["style"],body:[]},css:"background-color color font-family font-size font-style font-weight margin-left margin-right text-align text-decoration".split(" "),validTag(a){for(let d=0;d<g.XHTML.tags.length;d++)if(a===g.XHTML.tags[d])return!0;return!1},validAttribute(a,d){if(void 0!==g.XHTML.attributes[a]&&0<g.XHTML.attributes[a].length)for(let e=0;e<g.XHTML.attributes[a].length;e++)if(d===g.XHTML.attributes[a][e])return!0;
return!1},validCSS(a){for(let d=0;d<g.XHTML.css.length;d++)if(a===g.XHTML.css[d])return!0;return!1}},Status:{ERROR:0,CONNECTING:1,CONNFAIL:2,AUTHENTICATING:3,AUTHFAIL:4,CONNECTED:5,DISCONNECTED:6,DISCONNECTING:7,ATTACHED:8,REDIRECT:9,CONNTIMEOUT:10,BINDREQUIRED:11,ATTACHFAIL:12},ErrorCondition:{BAD_FORMAT:"bad-format",CONFLICT:"conflict",MISSING_JID_NODE:"x-strophe-bad-non-anon-jid",NO_AUTH_MECH:"no-auth-mech",UNKNOWN_REASON:"unknown"},LogLevel:{DEBUG:0,INFO:1,WARN:2,ERROR:3,FATAL:4},ElementType:{NORMAL:1,
TEXT:3,CDATA:4,FRAGMENT:11},TIMEOUT:1.1,SECONDARY_TIMEOUT:.1,addNamespace(a,d){g.NS[a]=d},forEachChild(a,d,e){for(let k=0;k<a.childNodes.length;k++){const p=a.childNodes[k];p.nodeType!==g.ElementType.NORMAL||d&&!this.isTagEqual(p,d)||e(p)}},isTagEqual:(a,d)=>a.tagName===d,_xmlGenerator:null,xmlGenerator:()=>(g._xmlGenerator||(g._xmlGenerator=f()),g._xmlGenerator),xmlElement(a){if(!a)return null;const d=g.xmlGenerator().createElement(a);for(let e=1;e<arguments.length;e++){const k=arguments[e];if(k)if("string"==
typeof k||"number"==typeof k)d.appendChild(g.xmlTextNode(k));else if("object"==typeof k&&"function"==typeof k.sort)for(let p=0;p<k.length;p++){const l=k[p];"object"==typeof l&&"function"==typeof l.sort&&void 0!==l[1]&&null!==l[1]&&d.setAttribute(l[0],l[1])}else if("object"==typeof k)for(const p in k)Object.prototype.hasOwnProperty.call(k,p)&&void 0!==k[p]&&null!==k[p]&&d.setAttribute(p,k[p])}return d},xmlescape:a=>a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/'/g,"&apos;").replace(/"/g,
"&quot;"),xmlunescape:a=>a.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&apos;/g,"'").replace(/&quot;/g,'"'),xmlTextNode:a=>g.xmlGenerator().createTextNode(a),xmlHtmlNode(a){let d;H?d=(new H).parseFromString(a,"text/xml"):(d=new ActiveXObject("Microsoft.XMLDOM"),d.async="false",d.loadXML(a));return d},getText(a){if(!a)return null;let d="";0===a.childNodes.length&&a.nodeType===g.ElementType.TEXT&&(d+=a.nodeValue);for(let e=0;e<a.childNodes.length;e++)a.childNodes[e].nodeType===
g.ElementType.TEXT&&(d+=a.childNodes[e].nodeValue);return g.xmlescape(d)},copyElement(a){let d;if(a.nodeType===g.ElementType.NORMAL){d=g.xmlElement(a.tagName);for(var e=0;e<a.attributes.length;e++)d.setAttribute(a.attributes[e].nodeName,a.attributes[e].value);for(e=0;e<a.childNodes.length;e++)d.appendChild(g.copyElement(a.childNodes[e]))}else a.nodeType===g.ElementType.TEXT&&(d=g.xmlGenerator().createTextNode(a.nodeValue));return d},createHtml(a){let d;if(a.nodeType===g.ElementType.NORMAL){var e=
a.nodeName.toLowerCase();if(g.XHTML.validTag(e))try{d=g.xmlElement(e);for(let k=0;k<g.XHTML.attributes[e].length;k++){const p=g.XHTML.attributes[e][k];let l=a.getAttribute(p);if(null!=l&&""!==l&&!1!==l&&0!==l)if("style"===p&&"object"==typeof l&&void 0!==l.cssText&&(l=l.cssText),"style"===p){const m=[],n=l.split(";");for(let r=0;r<n.length;r++){const w=n[r].split(":"),P=w[0].replace(/^\s*/,"").replace(/\s*$/,"").toLowerCase();if(g.XHTML.validCSS(P)){const R=w[1].replace(/^\s*/,"").replace(/\s*$/,"");
m.push(P+": "+R)}}0<m.length&&(l=m.join("; "),d.setAttribute(p,l))}else d.setAttribute(p,l)}for(e=0;e<a.childNodes.length;e++)d.appendChild(g.createHtml(a.childNodes[e]))}catch(k){d=g.xmlTextNode("")}else for(d=g.xmlGenerator().createDocumentFragment(),e=0;e<a.childNodes.length;e++)d.appendChild(g.createHtml(a.childNodes[e]))}else if(a.nodeType===g.ElementType.FRAGMENT)for(d=g.xmlGenerator().createDocumentFragment(),e=0;e<a.childNodes.length;e++)d.appendChild(g.createHtml(a.childNodes[e]));else a.nodeType===
g.ElementType.TEXT&&(d=g.xmlTextNode(a.nodeValue));return d},escapeNode:a=>"string"!=typeof a?a:a.replace(/^\s+|\s+$/g,"").replace(/\\/g,"\\5c").replace(/ /g,"\\20").replace(/"/g,"\\22").replace(/&/g,"\\26").replace(/'/g,"\\27").replace(/\//g,"\\2f").replace(/:/g,"\\3a").replace(/</g,"\\3c").replace(/>/g,"\\3e").replace(/@/g,"\\40"),unescapeNode:a=>"string"!=typeof a?a:a.replace(/\\20/g," ").replace(/\\22/g,'"').replace(/\\26/g,"&").replace(/\\27/g,"'").replace(/\\2f/g,"/").replace(/\\3a/g,":").replace(/\\3c/g,
"<").replace(/\\3e/g,">").replace(/\\40/g,"@").replace(/\\5c/g,"\\"),getNodeFromJid:a=>0>a.indexOf("@")?null:a.split("@")[0],getDomainFromJid(a){a=g.getBareJidFromJid(a);if(0>a.indexOf("@"))return a;a=a.split("@");return a.splice(0,1),a.join("@")},getResourceFromJid(a){if(!a)return null;a=a.split("/");return 2>a.length?null:(a.splice(0,1),a.join("/"))},getBareJidFromJid:a=>a?a.split("/")[0]:null,_handleError(a){void 0!==a.stack&&g.fatal(a.stack);a.sourceURL?g.fatal("error: "+this.handler+" "+a.sourceURL+
":"+a.line+" - "+a.name+": "+a.message):a.fileName?g.fatal("error: "+this.handler+" "+a.fileName+":"+a.lineNumber+" - "+a.name+": "+a.message):g.fatal("error: "+a.message)},log(a,d){var e;a!==this.LogLevel.FATAL||null!==(e=console)&&void 0!==e&&e.error(d)},debug(a){this.log(this.LogLevel.DEBUG,a)},info(a){this.log(this.LogLevel.INFO,a)},warn(a){this.log(this.LogLevel.WARN,a)},error(a){this.log(this.LogLevel.ERROR,a)},fatal(a){this.log(this.LogLevel.FATAL,a)},serialize(a){if(!a)return null;"function"==
typeof a.tree&&(a=a.tree());var d=[...Array(a.attributes.length).keys()].map(e=>a.attributes[e].nodeName);d.sort();d=d.reduce((e,k)=>`${e} ${k}="${g.xmlescape(a.attributes.getNamedItem(k).value)}"`,`<${a.nodeName}`);if(0<a.childNodes.length){d+=">";for(let e=0;e<a.childNodes.length;e++){const k=a.childNodes[e];switch(k.nodeType){case g.ElementType.NORMAL:d+=g.serialize(k);break;case g.ElementType.TEXT:d+=g.xmlescape(k.nodeValue);break;case g.ElementType.CDATA:d+="<![CDATA["+k.nodeValue+"]]\x3e"}}d+=
"</"+a.nodeName+">"}else d+="/>";return d},_requestId:0,_connectionPlugins:{},addConnectionPlugin(a,d){g._connectionPlugins[a]=d},Builder:class{constructor(a,d){"presence"!==a&&"message"!==a&&"iq"!==a||(d&&!d.xmlns?d.xmlns=g.NS.CLIENT:d||={xmlns:g.NS.CLIENT});this.node=this.nodeTree=g.xmlElement(a,d)}tree(){return this.nodeTree}toString(){return g.serialize(this.nodeTree)}up(){return this.node=this.node.parentNode,this}root(){return this.node=this.nodeTree,this}attrs(a){for(const d in a)Object.prototype.hasOwnProperty.call(a,
d)&&(void 0===a[d]?this.node.removeAttribute(d):this.node.setAttribute(d,a[d]));return this}c(a,d,e){a=g.xmlElement(a,d,e);return this.node.appendChild(a),"string"!=typeof e&&"number"!=typeof e&&(this.node=a),this}cnode(a){let d;const e=g.xmlGenerator();try{d=void 0!==e.importNode}catch(k){d=!1}a=d?e.importNode(a,!0):g.copyElement(a);return this.node.appendChild(a),this.node=a,this}t(a){a=g.xmlTextNode(a);return this.node.appendChild(a),this}h(a){const d=g.xmlGenerator().createElement("body");d.innerHTML=
a;for(a=g.createHtml(d);0<a.childNodes.length;)this.node.appendChild(a.childNodes[0]);return this}},Handler:function(a,d,e,k,p,l,m){this.handler=a;this.ns=d;this.name=e;this.type=k;this.id=p;this.options=m||{matchBareFromJid:!1,ignoreNamespaceFragment:!1};this.options.matchBare&&(g.warn('The "matchBare" option is deprecated, use "matchBareFromJid" instead.'),this.options.matchBareFromJid=this.options.matchBare,delete this.options.matchBare);this.options.matchBareFromJid?this.from=l?g.getBareJidFromJid(l):
null:this.from=l;this.user=!0}};g.Handler.prototype={getNamespace(a){a=a.getAttribute("xmlns");return a&&this.options.ignoreNamespaceFragment&&(a=a.split("#")[0]),a},namespaceMatch(a){let d=!1;return!this.ns||(g.forEachChild(a,null,e=>{this.getNamespace(e)===this.ns&&(d=!0)}),d||this.getNamespace(a)===this.ns)},isMatch(a){let d=a.getAttribute("from");this.options.matchBareFromJid&&(d=g.getBareJidFromJid(d));const e=a.getAttribute("type");return!(!this.namespaceMatch(a)||this.name&&!g.isTagEqual(a,
this.name)||this.type&&(Array.isArray(this.type)?-1===this.type.indexOf(e):e!==this.type)||this.id&&a.getAttribute("id")!==this.id||this.from&&d!==this.from)},run(a){let d=null;try{d=this.handler(a)}catch(e){throw g._handleError(e),e;}return d},toString(){return"{Handler: "+this.handler+"("+this.name+","+this.id+","+this.ns+")}"}};g.TimedHandler=class{constructor(a,d){this.period=a;this.handler=d;this.lastCalled=(new Date).getTime();this.user=!0}run(){return this.lastCalled=(new Date).getTime(),this.handler()}reset(){this.lastCalled=
(new Date).getTime()}toString(){return"{TimedHandler: "+this.handler+"("+this.period+")}"}};g.Connection=class{constructor(a,d){this.service=a;this.options=d||{};this.setProtocol();this.jid="";this.features=this.domain=null;this._sasl_data={};this.do_session=this.do_bind=!1;this.mechanisms={};this.timedHandlers=[];this.handlers=[];this.removeTimeds=[];this.removeHandlers=[];this.addTimeds=[];this.addHandlers=[];this.protocolErrorHandlers={HTTP:{},websocket:{}};this._disconnectTimeout=this._idleTimeout=
null;this.disconnecting=this.connected=this.authenticated=!1;this.do_authentication=!0;this.restored=this.paused=!1;this._data=[];this._uniqueId=0;this._sasl_challenge_handler=this._sasl_failure_handler=this._sasl_success_handler=null;this.maxRetries=5;this._idleTimeout=setTimeout(()=>this._onIdle(),100);Z(this.options.cookies);this.registerSASLMechanisms(this.options.mechanisms);this.iqFallbackHandler=new g.Handler(e=>this.send(F({type:"error",id:e.getAttribute("id")}).c("error",{type:"cancel"}).c("service-unavailable",
{xmlns:g.NS.STANZAS})),null,"iq",["get","set"]);for(const e in g._connectionPlugins)Object.prototype.hasOwnProperty.call(g._connectionPlugins,e)&&(a=function(){},a.prototype=g._connectionPlugins[e],this[e]=new a,this[e].init(this))}setProtocol(){const a=this.options.protocol||"";this.options.worker?this._proto=new g.WorkerWebsocket(this):0===this.service.indexOf("ws:")||0===this.service.indexOf("wss:")||0===a.indexOf("ws")?this._proto=new g.Websocket(this):this._proto=new g.Bosh(this)}reset(){this._proto._reset();
this.do_bind=this.do_session=!1;this.timedHandlers=[];this.handlers=[];this.removeTimeds=[];this.removeHandlers=[];this.addTimeds=[];this.addHandlers=[];this.restored=this.disconnecting=this.connected=this.authenticated=!1;this._data=[];this._requests=[];this._uniqueId=0}pause(){this.paused=!0}resume(){this.paused=!1}getUniqueId(a){const d="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){const k=16*Math.random()|0;return("x"===e?k:3&k|8).toString(16)});return"string"==typeof a||
"number"==typeof a?d+":"+a:d+""}addProtocolErrorHandler(a,d,e){this.protocolErrorHandlers[a][d]=e}connect(a,d,e,k,p,l,m){let n=7<arguments.length&&void 0!==arguments[7]?arguments[7]:3E3;this.jid=a;this.authzid=g.getBareJidFromJid(this.jid);this.authcid=m||g.getNodeFromJid(this.jid);this.pass=d;this.connect_callback=e;this.restored=this.authenticated=this.connected=this.disconnecting=!1;this.disconnection_timeout=n;this.domain=g.getDomainFromJid(this.jid);this._changeConnectStatus(g.Status.CONNECTING,
null);this._proto._connect(k,p,l)}attach(a,d,e,k,p,l,m){if(this._proto._attach)return this._proto._attach(a,d,e,k,p,l,m);a=Error('The "attach" method is not available for your connection protocol');throw a.name="StropheSessionError",a;}restore(a,d,e,k,p){if(!this._sessionCachingSupported())throw a=Error('The "restore" method can only be used with a BOSH connection.'),a.name="StropheSessionError",a;this._proto._restore(a,d,e,k,p)}_sessionCachingSupported(){if(this._proto instanceof g.Bosh){if(!JSON)return!1;
try{sessionStorage.setItem("_strophe_","_strophe_"),sessionStorage.removeItem("_strophe_")}catch(a){return!1}return!0}return!1}xmlInput(a){}xmlOutput(a){}rawInput(a){}rawOutput(a){}nextValidRid(a){}send(a){if(null!==a){if("function"==typeof a.sort)for(let d=0;d<a.length;d++)this._queueData(a[d]);else"function"==typeof a.tree?this._queueData(a.tree()):this._queueData(a);this._proto._send()}}flush(){clearTimeout(this._idleTimeout);this._onIdle()}sendPresence(a,d,e,k){let p=null;"function"==typeof a.tree&&
(a=a.tree());let l=a.getAttribute("id");if(l||(l=this.getUniqueId("sendPresence"),a.setAttribute("id",l)),"function"==typeof d||"function"==typeof e){const m=this.addHandler(n=>{p&&this.deleteTimedHandler(p);"error"===n.getAttribute("type")?e&&e(n):d&&d(n)},null,"presence",null,l);k&&(p=this.addTimedHandler(k,()=>(this.deleteHandler(m),e&&e(null),!1)))}return this.send(a),l}sendIQ(a,d,e,k){let p=null;"function"==typeof a.tree&&(a=a.tree());let l=a.getAttribute("id");if(l||(l=this.getUniqueId("sendIQ"),
a.setAttribute("id",l)),"function"==typeof d||"function"==typeof e){const m=this.addHandler(n=>{p&&this.deleteTimedHandler(p);const r=n.getAttribute("type");if("result"===r)d&&d(n);else{if("error"!==r)throw n=Error(`Got bad IQ type of ${r}`),n.name="StropheError",n;e&&e(n)}},null,"iq",["error","result"],l);k&&(p=this.addTimedHandler(k,()=>(this.deleteHandler(m),e&&e(null),!1)))}return this.send(a),l}_queueData(a){if(null===a||!a.tagName||!a.childNodes)throw a=Error("Cannot queue non-DOMElement."),
a.name="StropheError",a;this._data.push(a)}_sendRestart(){this._data.push("restart");this._proto._sendRestart();this._idleTimeout=setTimeout(()=>this._onIdle(),100)}addTimedHandler(a,d){a=new g.TimedHandler(a,d);return this.addTimeds.push(a),a}deleteTimedHandler(a){this.removeTimeds.push(a)}addHandler(a,d,e,k,p,l,m){a=new g.Handler(a,d,e,k,p,l,m);return this.addHandlers.push(a),a}deleteHandler(a){this.removeHandlers.push(a);a=this.addHandlers.indexOf(a);0<=a&&this.addHandlers.splice(a,1)}registerSASLMechanisms(a){this.mechanisms=
{};(a=a||[g.SASLAnonymous,g.SASLExternal,g.SASLOAuthBearer,g.SASLXOAuth2,g.SASLPlain,g.SASLSHA1]).forEach(d=>this.registerSASLMechanism(d))}registerSASLMechanism(a){a=new a;this.mechanisms[a.mechname]=a}disconnect(a){(this._changeConnectStatus(g.Status.DISCONNECTING,a),a?g.warn("Disconnect was called because: "+a):g.info("Disconnect was called"),this.connected)?(a=!1,this.disconnecting=!0,this.authenticated&&(a=G({xmlns:g.NS.CLIENT,type:"unavailable"})),this._disconnectTimeout=this._addSysTimedHandler(this.disconnection_timeout,
this._onDisconnectTimeout.bind(this)),this._proto._disconnect(a)):(g.warn("Disconnect was called before Strophe connected to the server"),this._proto._abortAllRequests(),this._doDisconnect())}_changeConnectStatus(a,d,e){for(const k in g._connectionPlugins)if(Object.prototype.hasOwnProperty.call(g._connectionPlugins,k)){const p=this[k];if(p.statusChanged)try{p.statusChanged(a,d)}catch(l){g.error(`${k} plugin caused an exception changing status: ${l}`)}}if(this.connect_callback)try{this.connect_callback(a,
d,e)}catch(k){g._handleError(k),g.error(`User connection callback caused an exception: ${k}`)}}_doDisconnect(a){"number"==typeof this._idleTimeout&&clearTimeout(this._idleTimeout);null!==this._disconnectTimeout&&(this.deleteTimedHandler(this._disconnectTimeout),this._disconnectTimeout=null);g.debug("_doDisconnect was called");this._proto._doDisconnect();this.restored=this.disconnecting=this.authenticated=!1;this.handlers=[];this.timedHandlers=[];this.removeTimeds=[];this.removeHandlers=[];this.addTimeds=
[];this.addHandlers=[];this._changeConnectStatus(g.Status.DISCONNECTED,a);this.connected=!1}_dataRecv(a,d){a=this._proto._reqToData(a);if(null!==a){this.xmlInput!==g.Connection.prototype.xmlInput&&(a.nodeName===this._proto.strip&&a.childNodes.length?this.xmlInput(a.childNodes[0]):this.xmlInput(a));for(this.rawInput!==g.Connection.prototype.rawInput&&(d?this.rawInput(d):this.rawInput(g.serialize(a)));0<this.removeHandlers.length;)d=this.removeHandlers.pop(),d=this.handlers.indexOf(d),0<=d&&this.handlers.splice(d,
1);for(;0<this.addHandlers.length;)this.handlers.push(this.addHandlers.pop());if(this.disconnecting&&this._proto._emptyQueue())return void this._doDisconnect();d=a.getAttribute("type");if(null!==d&&"terminate"===d){if(this.disconnecting)return;d=a.getAttribute("condition");a=a.getElementsByTagName("conflict");return null!==d?("remote-stream-error"===d&&0<a.length&&(d="conflict"),this._changeConnectStatus(g.Status.CONNFAIL,d)):this._changeConnectStatus(g.Status.CONNFAIL,g.ErrorCondition.UNKOWN_REASON),
void this._doDisconnect(d)}g.forEachChild(a,null,e=>{const k=[];this.handlers=this.handlers.reduce((p,l)=>{try{!l.isMatch(e)||!this.authenticated&&l.user?p.push(l):(l.run(e)&&p.push(l),k.push(l))}catch(m){g.warn("Removing Strophe handlers due to uncaught exception: "+m.message)}return p},[]);!k.length&&this.iqFallbackHandler.isMatch(e)&&this.iqFallbackHandler.run(e)})}}_connect_cb(a,d,e){let k;g.debug("_connect_cb was called");this.connected=!0;try{k=this._proto._reqToData(a)}catch(l){if(l.name!==
g.ErrorCondition.BAD_FORMAT)throw l;this._changeConnectStatus(g.Status.CONNFAIL,g.ErrorCondition.BAD_FORMAT);this._doDisconnect(g.ErrorCondition.BAD_FORMAT)}if(k&&(this.xmlInput!==g.Connection.prototype.xmlInput&&(k.nodeName===this._proto.strip&&k.childNodes.length?this.xmlInput(k.childNodes[0]):this.xmlInput(k)),this.rawInput!==g.Connection.prototype.rawInput&&(e?this.rawInput(e):this.rawInput(g.serialize(k))),this._proto._connect_cb(k)!==g.Status.CONNFAIL)){var p;if(p=k.getElementsByTagNameNS?0<
k.getElementsByTagNameNS(g.NS.STREAM,"features").length:0<k.getElementsByTagName("stream:features").length||0<k.getElementsByTagName("features").length,!p)return void this._proto._no_auth_received(d);a=Array.from(k.getElementsByTagName("mechanism")).map(l=>this.mechanisms[l.textContent]).filter(l=>l);0!==a.length||0!==k.getElementsByTagName("auth").length?!1!==this.do_authentication&&this.authenticate(a):this._proto._no_auth_received(d)}}sortMechanismsByPriority(a){for(let e=0;e<a.length-1;++e){let k=
e;for(var d=e+1;d<a.length;++d)a[d].priority>a[k].priority&&(k=d);k!==e&&(d=a[e],a[e]=a[k],a[k]=d)}return a}authenticate(a){this._attemptSASLAuth(a)||this._attemptLegacyAuth()}_attemptSASLAuth(a){a=this.sortMechanismsByPriority(a||[]);var d=!1;for(let e=0;e<a.length;++e)if(a[e].test(this)){this._sasl_success_handler=this._addSysHandler(this._sasl_success_cb.bind(this),null,"success",null,null);this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null);
this._sasl_challenge_handler=this._addSysHandler(this._sasl_challenge_cb.bind(this),null,"challenge",null,null);this._sasl_mechanism=a[e];this._sasl_mechanism.onStart(this);a=z("auth",{xmlns:g.NS.SASL,mechanism:this._sasl_mechanism.mechname});this._sasl_mechanism.isClientFirst&&(d=this._sasl_mechanism.clientChallenge(this),a.t(Q.btoa(d)));this.send(a.tree());d=!0;break}return d}_sasl_challenge_cb(a){a=Q.atob(g.getText(a));a=this._sasl_mechanism.onChallenge(this,a);const d=z("response",{xmlns:g.NS.SASL});
return""!==a&&d.t(Q.btoa(a)),this.send(d.tree()),!0}_attemptLegacyAuth(){null===g.getNodeFromJid(this.jid)?(this._changeConnectStatus(g.Status.CONNFAIL,g.ErrorCondition.MISSING_JID_NODE),this.disconnect(g.ErrorCondition.MISSING_JID_NODE)):(this._changeConnectStatus(g.Status.AUTHENTICATING,null),this._addSysHandler(this._onLegacyAuthIQResult.bind(this),null,null,null,"_auth_1"),this.send(F({type:"get",to:this.domain,id:"_auth_1"}).c("query",{xmlns:g.NS.AUTH}).c("username",{}).t(g.getNodeFromJid(this.jid)).tree()))}_onLegacyAuthIQResult(a){a=
F({type:"set",id:"_auth_2"}).c("query",{xmlns:g.NS.AUTH}).c("username",{}).t(g.getNodeFromJid(this.jid)).up().c("password").t(this.pass);return g.getResourceFromJid(this.jid)||(this.jid=g.getBareJidFromJid(this.jid)+"/strophe"),a.up().c("resource",{}).t(g.getResourceFromJid(this.jid)),this._addSysHandler(this._auth2_cb.bind(this),null,null,null,"_auth_2"),this.send(a.tree()),!1}_sasl_success_cb(a){if(this._sasl_data["server-signature"]){let k;a=Q.atob(g.getText(a)).match(/([a-z]+)=([^,]+)(,|$)/);
if("v"===a[1]&&(k=a[2]),k!==this._sasl_data["server-signature"])return this.deleteHandler(this._sasl_failure_handler),this._sasl_failure_handler=null,this._sasl_challenge_handler&&(this.deleteHandler(this._sasl_challenge_handler),this._sasl_challenge_handler=null),this._sasl_data={},this._sasl_failure_cb(null)}g.info("SASL authentication succeeded.");this._sasl_mechanism&&this._sasl_mechanism.onSuccess();this.deleteHandler(this._sasl_failure_handler);this._sasl_failure_handler=null;this._sasl_challenge_handler&&
(this.deleteHandler(this._sasl_challenge_handler),this._sasl_challenge_handler=null);const d=[],e=(k,p)=>{for(;k.length;)this.deleteHandler(k.pop());return this._onStreamFeaturesAfterSASL(p),!1};return d.push(this._addSysHandler(k=>e(d,k),null,"stream:features",null,null)),d.push(this._addSysHandler(k=>e(d,k),g.NS.STREAM,"features",null,null)),this._sendRestart(),!1}_onStreamFeaturesAfterSASL(a){this.features=a;for(let d=0;d<a.childNodes.length;d++){const e=a.childNodes[d];"bind"===e.nodeName&&(this.do_bind=
!0);"session"===e.nodeName&&(this.do_session=!0)}return this.do_bind?(this.options.explicitResourceBinding?this._changeConnectStatus(g.Status.BINDREQUIRED,null):this.bind(),!1):(this._changeConnectStatus(g.Status.AUTHFAIL,null),!1)}bind(){if(!this.do_bind)return void g.log(g.LogLevel.INFO,'Strophe.Connection.prototype.bind called but "do_bind" is false');this._addSysHandler(this._onResourceBindResultIQ.bind(this),null,null,null,"_bind_auth_2");const a=g.getResourceFromJid(this.jid);a?this.send(F({type:"set",
id:"_bind_auth_2"}).c("bind",{xmlns:g.NS.BIND}).c("resource",{}).t(a).tree()):this.send(F({type:"set",id:"_bind_auth_2"}).c("bind",{xmlns:g.NS.BIND}).tree())}_onResourceBindResultIQ(a){if("error"===a.getAttribute("type")){g.warn("Resource binding failed.");var d;return 0<a.getElementsByTagName("conflict").length&&(d=g.ErrorCondition.CONFLICT),this._changeConnectStatus(g.Status.AUTHFAIL,d,a),!1}d=a.getElementsByTagName("bind");if(!(0<d.length))return g.warn("Resource binding failed."),this._changeConnectStatus(g.Status.AUTHFAIL,
null,a),!1;a=d[0].getElementsByTagName("jid");0<a.length&&(this.authenticated=!0,this.jid=g.getText(a[0]),this.do_session?this._establishSession():this._changeConnectStatus(g.Status.CONNECTED,null))}_establishSession(){if(!this.do_session)throw Error(`Strophe.Connection.prototype._establishSession called but apparently ${g.NS.SESSION} wasn't advertised by the server`);this._addSysHandler(this._onSessionResultIQ.bind(this),null,null,null,"_session_auth_2");this.send(F({type:"set",id:"_session_auth_2"}).c("session",
{xmlns:g.NS.SESSION}).tree())}_onSessionResultIQ(a){if("result"===a.getAttribute("type"))this.authenticated=!0,this._changeConnectStatus(g.Status.CONNECTED,null);else if("error"===a.getAttribute("type"))return this.authenticated=!1,g.warn("Session creation failed."),this._changeConnectStatus(g.Status.AUTHFAIL,null,a),!1;return!1}_sasl_failure_cb(a){return this._sasl_success_handler&&(this.deleteHandler(this._sasl_success_handler),this._sasl_success_handler=null),this._sasl_challenge_handler&&(this.deleteHandler(this._sasl_challenge_handler),
this._sasl_challenge_handler=null),this._sasl_mechanism&&this._sasl_mechanism.onFailure(),this._changeConnectStatus(g.Status.AUTHFAIL,null,a),!1}_auth2_cb(a){return"result"===a.getAttribute("type")?(this.authenticated=!0,this._changeConnectStatus(g.Status.CONNECTED,null)):"error"===a.getAttribute("type")&&(this._changeConnectStatus(g.Status.AUTHFAIL,null,a),this.disconnect("authentication failed")),!1}_addSysTimedHandler(a,d){a=new g.TimedHandler(a,d);return a.user=!1,this.addTimeds.push(a),a}_addSysHandler(a,
d,e,k,p){a=new g.Handler(a,d,e,k,p);return a.user=!1,this.addHandlers.push(a),a}_onDisconnectTimeout(){return g.debug("_onDisconnectTimeout was called"),this._changeConnectStatus(g.Status.CONNTIMEOUT,null),this._proto._onDisconnectTimeout(),this._doDisconnect(),!1}_onIdle(){for(;0<this.addTimeds.length;)this.timedHandlers.push(this.addTimeds.pop());for(;0<this.removeTimeds.length;){var a=this.removeTimeds.pop();a=this.timedHandlers.indexOf(a);0<=a&&this.timedHandlers.splice(a,1)}a=(new Date).getTime();
const d=[];for(let e=0;e<this.timedHandlers.length;e++){const k=this.timedHandlers[e];if(this.authenticated||!k.user)0>=k.lastCalled+k.period-a?k.run()&&d.push(k):d.push(k)}this.timedHandlers=d;clearTimeout(this._idleTimeout);this._proto._onIdle();this.connected&&(this._idleTimeout=setTimeout(()=>this._onIdle(),100))}};g.SASLMechanism=K;g.SASLAnonymous=class extends K{constructor(){super(0<arguments.length&&void 0!==arguments[0]?arguments[0]:"ANONYMOUS",1<arguments.length&&void 0!==arguments[1]&&
arguments[1],2<arguments.length&&void 0!==arguments[2]?arguments[2]:20)}test(a){return null===a.authcid}};g.SASLPlain=class extends K{constructor(){super(0<arguments.length&&void 0!==arguments[0]?arguments[0]:"PLAIN",!(1<arguments.length&&void 0!==arguments[1])||arguments[1],2<arguments.length&&void 0!==arguments[2]?arguments[2]:50)}test(a){return null!==a.authcid}onChallenge(a){const {authcid:d,authzid:e,domain:k,pass:p}=a;if(!k)throw Error("SASLPlain onChallenge: domain is not defined!");a=e!==
`${d}@${k}`?e:"";return a+="\x00",a+=d,a+="\x00",a+=p,O(a)}};g.SASLSHA1=class extends K{constructor(){super(0<arguments.length&&void 0!==arguments[0]?arguments[0]:"SCRAM-SHA-1",!(1<arguments.length&&void 0!==arguments[1])||arguments[1],2<arguments.length&&void 0!==arguments[2]?arguments[2]:60)}test(a){return null!==a.authcid}onChallenge(a,d){var e;let k="c=biws,",p=`${a._sasl_data["client-first-message-bare"]},${d},`;var l=a._sasl_data.cnonce;for(e=/([a-z]+)=([^,]+)(,|$)/;d.match(e);){const w=d.match(e);
switch(d=d.replace(w[0],""),w[1]){case "r":var m=w[2];break;case "s":var n=w[2];break;case "i":var r=w[2]}}if(m.slice(0,l.length)!==l)return a._sasl_data={},a._sasl_failure_cb();k+="r="+m;p+=k;n=atob(n);n+="\x00\x00\x00\u0001";m=O(a.pass);n=d=E.core_hmac_sha1(m,n);for(l=1;l<r;l++){e=E.core_hmac_sha1(m,E.binb2str(d));for(d=0;5>d;d++)n[d]^=e[d];d=e}n=E.binb2str(n);r=E.core_hmac_sha1(n,"Client Key");d=E.str_hmac_sha1(n,"Server Key");n=E.core_hmac_sha1(E.str_sha1(E.binb2str(r)),p);a._sasl_data["server-signature"]=
E.b64_hmac_sha1(d,p);for(d=0;5>d;d++)r[d]^=n[d];return k+=",p="+btoa(E.binb2str(r)),k}clientChallenge(a,d){d=d||Y.hexdigest(""+1234567890*Math.random());let e="n="+O(a.authcid);return e+=",r=",e+=d,a._sasl_data.cnonce=d,a._sasl_data["client-first-message-bare"]=e,e="n,,"+e,e}};g.SASLOAuthBearer=class extends K{constructor(){super(0<arguments.length&&void 0!==arguments[0]?arguments[0]:"OAUTHBEARER",!(1<arguments.length&&void 0!==arguments[1])||arguments[1],2<arguments.length&&void 0!==arguments[2]?
arguments[2]:40)}test(a){return null!==a.pass}onChallenge(a){let d="n,";return null!==a.authcid&&(d=d+"a="+a.authzid),d+=",",d+="\u0001",d+="auth=Bearer ",d+=a.pass,d+="\u0001",d+="\u0001",O(d)}};g.SASLExternal=class extends K{constructor(){super(0<arguments.length&&void 0!==arguments[0]?arguments[0]:"EXTERNAL",!(1<arguments.length&&void 0!==arguments[1])||arguments[1],2<arguments.length&&void 0!==arguments[2]?arguments[2]:10)}onChallenge(a){return a.authcid===a.authzid?"":a.authzid}};g.SASLXOAuth2=
class extends K{constructor(){super(0<arguments.length&&void 0!==arguments[0]?arguments[0]:"X-OAUTH2",!(1<arguments.length&&void 0!==arguments[1])||arguments[1],2<arguments.length&&void 0!==arguments[2]?arguments[2]:30)}test(a){return null!==a.pass}onChallenge(a){let d="\x00";return null!==a.authcid&&(d+=a.authzid),d+="\x00",d+=a.pass,O(d)}};g.Request=class{constructor(a,d,e,k){this.id=++g._requestId;this.xmlData=a;this.data=g.serialize(a);this.func=this.origFunc=d;this.rid=e;this.date=NaN;this.sends=
k||0;this.abort=!1;this.dead=null;this.age=function(){return this.date?(new Date-this.date)/1E3:0};this.timeDead=function(){return this.dead?(new Date-this.dead)/1E3:0};this.xhr=this._newXHR()}getResponse(){var a=null;if(this.xhr.responseXML&&this.xhr.responseXML.documentElement){if(a=this.xhr.responseXML.documentElement,"parsererror"===a.tagName)throw g.error("invalid response received"),g.error("responseText: "+this.xhr.responseText),g.error("responseXML: "+g.serialize(this.xhr.responseXML)),Error("parsererror");
}else if(this.xhr.responseText){if(g.debug("Got responseText but no responseXML; attempting to parse it with DOMParser..."),a=(new H).parseFromString(this.xhr.responseText,"application/xml").documentElement,!a)throw Error("Parsing produced null node");if(a.querySelector("parsererror"))throw g.error("invalid response received: "+a.querySelector("parsererror").textContent),g.error("responseText: "+this.xhr.responseText),a=Error(),a.name=g.ErrorCondition.BAD_FORMAT,a;}return a}_newXHR(){let a=null;return window.XMLHttpRequest?
(a=new XMLHttpRequest,a.overrideMimeType&&a.overrideMimeType("text/xml; charset=utf-8")):window.ActiveXObject&&(a=new ActiveXObject("Microsoft.XMLHTTP")),a.onreadystatechange=this.func.bind(null,this),a}};g.Bosh=class a{constructor(d){this._conn=d;this.rid=Math.floor(4294967295*Math.random());this.sid=null;this.hold=1;this.wait=60;this.window=5;this.errors=0;this.lastResponseHeaders=this.inactivity=null;this._requests=[]}_buildBody(){const d=z("body",{rid:this.rid++,xmlns:g.NS.HTTPBIND});return null!==
this.sid&&d.attrs({sid:this.sid}),this._conn.options.keepalive&&this._conn._sessionCachingSupported()&&this._cacheSession(),d}_reset(){this.rid=Math.floor(4294967295*Math.random());this.sid=null;this.errors=0;this._conn._sessionCachingSupported()&&window.sessionStorage.removeItem("strophe-bosh-session");this._conn.nextValidRid(this.rid)}_connect(d,e,k){this.wait=d||this.wait;this.hold=e||this.hold;this.errors=0;d=this._buildBody().attrs({to:this._conn.domain,"xml:lang":"en",wait:this.wait,hold:this.hold,
content:"text/xml; charset=utf-8",ver:"1.6","xmpp:version":"1.0","xmlns:xmpp":g.NS.BOSH});k&&d.attrs({route:k});k=this._conn._connect_cb;this._requests.push(new g.Request(d.tree(),this._onRequestStateChange.bind(this,k.bind(this._conn)),d.tree().getAttribute("rid")));this._throttledRequestHandler()}_attach(d,e,k,p,l,m,n){this._conn.jid=d;this.sid=e;this.rid=k;this._conn.connect_callback=p;this._conn.domain=g.getDomainFromJid(this._conn.jid);this._conn.authenticated=!0;this._conn.connected=!0;this.wait=
l||this.wait;this.hold=m||this.hold;this.window=n||this.window;this._conn._changeConnectStatus(g.Status.ATTACHED,null)}_restore(d,e,k,p,l){const m=JSON.parse(window.sessionStorage.getItem("strophe-bosh-session"));if(!(null!=m&&m.rid&&m.sid&&m.jid&&(null==d||g.getBareJidFromJid(m.jid)===g.getBareJidFromJid(d)||null===g.getNodeFromJid(d)&&g.getDomainFromJid(m.jid)===d)))throw d=Error("_restore: no restoreable session."),d.name="StropheSessionError",d;this._conn.restored=!0;this._attach(m.jid,m.sid,
m.rid,e,k,p,l)}_cacheSession(){this._conn.authenticated?this._conn.jid&&this.rid&&this.sid&&window.sessionStorage.setItem("strophe-bosh-session",JSON.stringify({jid:this._conn.jid,rid:this.rid,sid:this.sid})):window.sessionStorage.removeItem("strophe-bosh-session")}_connect_cb(d){var e=d.getAttribute("type");if(null!==e&&"terminate"===e)return e=d.getAttribute("condition"),g.error("BOSH-Connection failed: "+e),d=d.getElementsByTagName("conflict"),null!==e?("remote-stream-error"===e&&0<d.length&&(e=
"conflict"),this._conn._changeConnectStatus(g.Status.CONNFAIL,e)):this._conn._changeConnectStatus(g.Status.CONNFAIL,"unknown"),this._conn._doDisconnect(e),g.Status.CONNFAIL;this.sid||(this.sid=d.getAttribute("sid"));(e=d.getAttribute("requests"))&&(this.window=parseInt(e,10));(e=d.getAttribute("hold"))&&(this.hold=parseInt(e,10));(e=d.getAttribute("wait"))&&(this.wait=parseInt(e,10));(d=d.getAttribute("inactivity"))&&(this.inactivity=parseInt(d,10))}_disconnect(d){this._sendTerminate(d)}_doDisconnect(){this.sid=
null;this.rid=Math.floor(4294967295*Math.random());this._conn._sessionCachingSupported()&&window.sessionStorage.removeItem("strophe-bosh-session");this._conn.nextValidRid(this.rid)}_emptyQueue(){return 0===this._requests.length}_callProtocolErrorHandlers(d){d=a._getRequestStatus(d);const e=this._conn.protocolErrorHandlers.HTTP[d];e&&e.call(this,d)}_hitError(d){this.errors++;g.warn("request errored, status: "+d+", number of errors: "+this.errors);4<this.errors&&this._conn._onDisconnectTimeout()}_no_auth_received(d){g.warn("Server did not yet offer a supported authentication mechanism. Sending a blank poll request.");
d=d?d.bind(this._conn):this._conn._connect_cb.bind(this._conn);const e=this._buildBody();this._requests.push(new g.Request(e.tree(),this._onRequestStateChange.bind(this,d),e.tree().getAttribute("rid")));this._throttledRequestHandler()}_onDisconnectTimeout(){this._abortAllRequests()}_abortAllRequests(){for(;0<this._requests.length;){const d=this._requests.pop();d.abort=!0;d.xhr.abort();d.xhr.onreadystatechange=function(){}}}_onIdle(){var d=this._conn._data;if(this._conn.authenticated&&0===this._requests.length&&
0===d.length&&!this._conn.disconnecting&&(g.debug("no requests during idle cycle, sending blank request"),d.push(null)),!this._conn.paused){if(2>this._requests.length&&0<d.length){const e=this._buildBody();for(let k=0;k<d.length;k++)null!==d[k]&&("restart"===d[k]?e.attrs({to:this._conn.domain,"xml:lang":"en","xmpp:restart":"true","xmlns:xmpp":g.NS.BOSH}):e.cnode(d[k]).up());delete this._conn._data;this._conn._data=[];this._requests.push(new g.Request(e.tree(),this._onRequestStateChange.bind(this,
this._conn._dataRecv.bind(this._conn)),e.tree().getAttribute("rid")));this._throttledRequestHandler()}0<this._requests.length&&(d=this._requests[0].age(),null!==this._requests[0].dead&&this._requests[0].timeDead()>Math.floor(g.SECONDARY_TIMEOUT*this.wait)&&this._throttledRequestHandler(),d>Math.floor(g.TIMEOUT*this.wait)&&(g.warn("Request "+this._requests[0].id+" timed out, over "+Math.floor(g.TIMEOUT*this.wait)+" seconds since last activity"),this._throttledRequestHandler()))}}static _getRequestStatus(d,
e){let k;if(4===d.xhr.readyState)try{k=d.xhr.status}catch(p){g.error("Caught an error while retrieving a request's status, reqStatus: "+k)}return void 0===k&&(k="number"==typeof e?e:0),k}_onRequestStateChange(d,e){if(g.debug("request id "+e.id+"."+e.sends+" state changed to "+e.xhr.readyState),e.abort)return void(e.abort=!1);if(4===e.xhr.readyState){var k=a._getRequestStatus(e);if(this.lastResponseHeaders=e.xhr.getAllResponseHeaders(),this._conn.disconnecting&&400<=k)return this._hitError(k),void this._callProtocolErrorHandlers(e);
var p=this._requests[0]===e,l=this._requests[1]===e,m=0<k&&500>k,n=e.sends>this._conn.maxRetries;(m||n)&&(this._removeRequest(e),g.debug("request id "+e.id+" should now be removed"));200===k?((l||p&&0<this._requests.length&&this._requests[0].age()>Math.floor(g.SECONDARY_TIMEOUT*this.wait))&&this._restartRequest(0),this._conn.nextValidRid(Number(e.rid)+1),g.debug("request id "+e.id+"."+e.sends+" got 200"),d(e),this.errors=0):0===k||400<=k&&600>k||12E3<=k?(g.error("request id "+e.id+"."+e.sends+" error "+
k+" happened"),this._hitError(k),this._callProtocolErrorHandlers(e),400<=k&&500>k&&(this._conn._changeConnectStatus(g.Status.DISCONNECTING,null),this._conn._doDisconnect())):g.error("request id "+e.id+"."+e.sends+" error "+k+" happened");m||n?n&&!this._conn.connected&&this._conn._changeConnectStatus(g.Status.CONNFAIL,"giving-up"):this._throttledRequestHandler()}}_processRequest(d){let e=this._requests[d];var k=a._getRequestStatus(e,-1);if(e.sends>this._conn.maxRetries)return void this._conn._onDisconnectTimeout();
var p=e.age();p=!isNaN(p)&&p>Math.floor(g.TIMEOUT*this.wait);const l=null!==e.dead&&e.timeDead()>Math.floor(g.SECONDARY_TIMEOUT*this.wait);k=4===e.xhr.readyState&&(1>k||500<=k);if((p||l||k)&&(l&&g.error(`Request ${this._requests[d].id} timed out (secondary), restarting`),e.abort=!0,e.xhr.abort(),e.xhr.onreadystatechange=function(){},this._requests[d]=new g.Request(e.xmlData,e.origFunc,e.rid,e.sends),e=this._requests[d]),0===e.xhr.readyState){g.debug("request id "+e.id+"."+e.sends+" posting");try{const n=
this._conn.options.contentType||"text/xml; charset=utf-8";e.xhr.open("POST",this._conn.service,!this._conn.options.sync);void 0!==e.xhr.setRequestHeader&&e.xhr.setRequestHeader("Content-Type",n);this._conn.options.withCredentials&&(e.xhr.withCredentials=!0)}catch(n){return g.error("XHR open failed: "+n.toString()),this._conn.connected||this._conn._changeConnectStatus(g.Status.CONNFAIL,"bad-service"),void this._conn.disconnect()}const m=()=>{if(e.date=new Date,this._conn.options.customHeaders){const n=
this._conn.options.customHeaders;for(const r in n)Object.prototype.hasOwnProperty.call(n,r)&&e.xhr.setRequestHeader(r,n[r])}e.xhr.send(e.data)};1<e.sends?setTimeout(function(){m()},1E3*Math.min(Math.floor(g.TIMEOUT*this.wait),Math.pow(e.sends,3))):m();e.sends++;this._conn.xmlOutput!==g.Connection.prototype.xmlOutput&&(e.xmlData.nodeName===this.strip&&e.xmlData.childNodes.length?this._conn.xmlOutput(e.xmlData.childNodes[0]):this._conn.xmlOutput(e.xmlData));this._conn.rawOutput!==g.Connection.prototype.rawOutput&&
this._conn.rawOutput(e.data)}else g.debug("_processRequest: "+(0===d?"first":"second")+" request has readyState of "+e.xhr.readyState)}_removeRequest(d){g.debug("removing request");for(let e=this._requests.length-1;0<=e;e--)d===this._requests[e]&&this._requests.splice(e,1);d.xhr.onreadystatechange=function(){};this._throttledRequestHandler()}_restartRequest(d){const e=this._requests[d];null===e.dead&&(e.dead=new Date);this._processRequest(d)}_reqToData(d){try{return d.getResponse()}catch(e){if("parsererror"!==
e.message)throw e;this._conn.disconnect("strophe-parsererror")}}_sendTerminate(d){g.debug("_sendTerminate was called");const e=this._buildBody().attrs({type:"terminate"});d&&e.cnode(d.tree());d=new g.Request(e.tree(),this._onRequestStateChange.bind(this,this._conn._dataRecv.bind(this._conn)),e.tree().getAttribute("rid"));this._requests.push(d);this._throttledRequestHandler()}_send(){clearTimeout(this._conn._idleTimeout);this._throttledRequestHandler();this._conn._idleTimeout=setTimeout(()=>this._conn._onIdle(),
100)}_sendRestart(){this._throttledRequestHandler();clearTimeout(this._conn._idleTimeout)}_throttledRequestHandler(){this._requests?g.debug("_throttledRequestHandler called with "+this._requests.length+" requests"):g.debug("_throttledRequestHandler called with undefined requests");this._requests&&0!==this._requests.length&&(0<this._requests.length&&this._processRequest(0),1<this._requests.length&&Math.abs(this._requests[0].rid-this._requests[1].rid)<this.window&&this._processRequest(1))}};g.Bosh.prototype.strip=
null;g.Websocket=class{constructor(a){this._conn=a;this.strip="wrapper";const d=a.service;if(0!==d.indexOf("ws:")&&0!==d.indexOf("wss:")){let e="";"ws"===a.options.protocol&&"https:"!==window.location.protocol?e+="ws":e+="wss";e+="://"+window.location.host;0!==d.indexOf("/")?e+=window.location.pathname+d:e+=d;a.service=e}}_buildStream(){return z("open",{xmlns:g.NS.FRAMING,to:this._conn.domain,version:"1.0"})}_checkStreamError(a,d){var e;if(e=a.getElementsByTagNameNS?a.getElementsByTagNameNS(g.NS.STREAM,
"error"):a.getElementsByTagName("stream:error"),0===e.length)return!1;var k=e[0];e=a="";for(let p=0;p<k.childNodes.length;p++){const l=k.childNodes[p];if("urn:ietf:params:xml:ns:xmpp-streams"!==l.getAttribute("xmlns"))break;"text"===l.nodeName?e=l.textContent:a=l.nodeName}k="WebSocket stream error: ";return k+=a||"unknown",e&&(k+=" - "+e),g.error(k),this._conn._changeConnectStatus(d,a),this._conn._doDisconnect(),!0}_reset(){}_connect(){this._closeSocket();this.socket=new T(this._conn.service,"xmpp");
this.socket.onopen=()=>this._onOpen();this.socket.onerror=a=>this._onError(a);this.socket.onclose=a=>this._onClose(a);this.socket.onmessage=a=>this._onInitialMessage(a)}_connect_cb(a){if(this._checkStreamError(a,g.Status.CONNFAIL))return g.Status.CONNFAIL}_handleStreamStart(a){let d=!1;const e=a.getAttribute("xmlns");"string"!=typeof e?d="Missing xmlns in <open />":e!==g.NS.FRAMING&&(d="Wrong xmlns in <open />: "+e);a=a.getAttribute("version");return"string"!=typeof a?d="Missing version in <open />":
"1.0"!==a&&(d="Wrong version in <open />: "+a),!d||(this._conn._changeConnectStatus(g.Status.CONNFAIL,d),this._conn._doDisconnect(),!1)}_onInitialMessage(a){if(0===a.data.indexOf("<open ")||0===a.data.indexOf("<?xml")){var d=a.data.replace(/^(<\?.*?\?>\s*)*/,"");""!==d&&(d=(new H).parseFromString(d,"text/xml").documentElement,this._conn.xmlInput(d),this._conn.rawInput(a.data),this._handleStreamStart(d)&&this._connect_cb(d))}else 0===a.data.indexOf("<close ")?(d=(new H).parseFromString(a.data,"text/xml").documentElement,
this._conn.xmlInput(d),this._conn.rawInput(a.data),(a=d.getAttribute("see-other-uri"))?(d=this._conn.service,(0<=d.indexOf("wss:")&&0<=a.indexOf("wss:")||0<=d.indexOf("ws:"))&&(this._conn._changeConnectStatus(g.Status.REDIRECT,"Received see-other-uri, resetting connection"),this._conn.reset(),this._conn.service=a,this._connect())):(this._conn._changeConnectStatus(g.Status.CONNFAIL,"Received closing stream"),this._conn._doDisconnect())):(this._replaceMessageHandler(),d=this._streamWrap(a.data),d=(new H).parseFromString(d,
"text/xml").documentElement,this._conn._connect_cb(d,null,a.data))}_replaceMessageHandler(){this.socket.onmessage=a=>this._onMessage(a)}_disconnect(a){if(this.socket&&this.socket.readyState!==T.CLOSED){a&&this._conn.send(a);a=z("close",{xmlns:g.NS.FRAMING});this._conn.xmlOutput(a.tree());a=g.serialize(a);this._conn.rawOutput(a);try{this.socket.send(a)}catch(d){g.warn("Couldn't send <close /> tag.")}}setTimeout(()=>this._conn._doDisconnect,0)}_doDisconnect(){g.debug("WebSockets _doDisconnect was called");
this._closeSocket()}_streamWrap(a){return"<wrapper>"+a+"</wrapper>"}_closeSocket(){if(this.socket)try{this.socket.onclose=null,this.socket.onerror=null,this.socket.onmessage=null,this.socket.close()}catch(a){g.debug(a.message)}this.socket=null}_emptyQueue(){return!0}_onClose(a){this._conn.connected&&!this._conn.disconnecting?(g.error("Websocket closed unexpectedly"),this._conn._doDisconnect()):a&&1006===a.code&&!this._conn.connected&&this.socket?(g.error("Websocket closed unexcectedly"),this._conn._changeConnectStatus(g.Status.CONNFAIL,
"The WebSocket connection could not be established or was disconnected."),this._conn._doDisconnect()):g.debug("Websocket closed")}_no_auth_received(a){g.error("Server did not offer a supported authentication mechanism");this._conn._changeConnectStatus(g.Status.CONNFAIL,g.ErrorCondition.NO_AUTH_MECH);a&&a.call(this._conn);this._conn._doDisconnect()}_onDisconnectTimeout(){}_abortAllRequests(){}_onError(a){g.error("Websocket error "+JSON.stringify(a));this._conn._changeConnectStatus(g.Status.CONNFAIL,
"The WebSocket connection could not be established or was disconnected.");this._disconnect()}_onIdle(){const a=this._conn._data;if(0<a.length&&!this._conn.paused){for(let d=0;d<a.length;d++)if(null!==a[d]){let e;e="restart"===a[d]?this._buildStream().tree():a[d];const k=g.serialize(e);this._conn.xmlOutput(e);this._conn.rawOutput(k);this.socket.send(k)}this._conn._data=[]}}_onMessage(a){var d;if('<close xmlns="urn:ietf:params:xml:ns:xmpp-framing" />'===a.data)return this._conn.rawInput('<close xmlns="urn:ietf:params:xml:ns:xmpp-framing" />'),
this._conn.xmlInput(a),void(this._conn.disconnecting||this._conn._doDisconnect());if(0===a.data.search("<open ")){if(d=(new H).parseFromString(a.data,"text/xml").documentElement,!this._handleStreamStart(d))return}else d=this._streamWrap(a.data),d=(new H).parseFromString(d,"text/xml").documentElement;return this._checkStreamError(d,g.Status.ERROR)?void 0:this._conn.disconnecting&&"presence"===d.firstChild.nodeName&&"unavailable"===d.firstChild.getAttribute("type")?(this._conn.xmlInput(d),void this._conn.rawInput(g.serialize(d))):
void this._conn._dataRecv(d,a.data)}_onOpen(){g.debug("Websocket open");var a=this._buildStream();this._conn.xmlOutput(a.tree());a=g.serialize(a);this._conn.rawOutput(a);this.socket.send(a)}_reqToData(a){return a}_send(){this._conn.flush()}_sendRestart(){clearTimeout(this._conn._idleTimeout);this._conn._onIdle.bind(this._conn)()}};const L={};L.debug=g.LogLevel.DEBUG;L.info=g.LogLevel.INFO;L.warn=g.LogLevel.WARN;L.error=g.LogLevel.ERROR;L.fatal=g.LogLevel.FATAL;g.WorkerWebsocket=class extends g.Websocket{constructor(a){super(a);
this._conn=a;this.worker=new SharedWorker(this._conn.options.worker,"Strophe XMPP Connection");this.worker.onerror=d=>{var e;null===(e=console)||void 0===e||e.error(d);g.log(g.LogLevel.ERROR,`Shared Worker Error: ${d}`)}}get socket(){return{send:a=>this.worker.port.postMessage(["send",a])}}_connect(){this._messageHandler=a=>this._onInitialMessage(a);this.worker.port.start();this.worker.port.onmessage=a=>this._onWorkerMessage(a);this.worker.port.postMessage(["_connect",this._conn.service,this._conn.jid])}_attach(a){this._messageHandler=
d=>this._onMessage(d);this._conn.connect_callback=a;this.worker.port.start();this.worker.port.onmessage=d=>this._onWorkerMessage(d);this.worker.port.postMessage(["_attach",this._conn.service])}_attachCallback(a,d){a===g.Status.ATTACHED?(this._conn.jid=d,this._conn.authenticated=!0,this._conn.connected=!0,this._conn.restored=!0,this._conn._changeConnectStatus(g.Status.ATTACHED)):a===g.Status.ATTACHFAIL&&(this._conn.authenticated=!1,this._conn.connected=!1,this._conn.restored=!1,this._conn._changeConnectStatus(g.Status.ATTACHFAIL))}_disconnect(a,
d){d&&this._conn.send(d);a=z("close",{xmlns:g.NS.FRAMING});this._conn.xmlOutput(a.tree());a=g.serialize(a);this._conn.rawOutput(a);this.worker.port.postMessage(["send",a]);this._conn._doDisconnect()}_onClose(a){this._conn.connected&&!this._conn.disconnecting?(g.error("Websocket closed unexpectedly"),this._conn._doDisconnect()):a&&1006===a.code&&!this._conn.connected?(g.error("Websocket closed unexcectedly"),this._conn._changeConnectStatus(g.Status.CONNFAIL,"The WebSocket connection could not be established or was disconnected."),
this._conn._doDisconnect()):g.debug("Websocket closed")}_closeSocket(){this.worker.port.postMessage(["_closeSocket"])}_replaceMessageHandler(){this._messageHandler=a=>this._onMessage(a)}_onWorkerMessage(a){const {data:d}=a,e=d[0];if("_onMessage"===e)this._messageHandler(d[1]);else if(e in this)try{this[e].apply(this,a.data.slice(1))}catch(k){g.log(g.LogLevel.ERROR,k)}else"log"===e?g.log(L[d[1]],d[2]):g.log(g.LogLevel.ERROR,`Found unhandled service worker message: ${d}`)}};J.$build=z;J.$iq=F;J.$msg=
N;J.$pres=G;J.Strophe=g;const {b64_sha1:aa}=E;b.$build=z;b.$iq=F;b.$msg=N;b.$pres=G;b.Strophe=g;b.b64_sha1=aa;Object.defineProperty(b,"__esModule",{value:!0})});Strophe.addConnectionPlugin("disco",{_connection:null,_identities:[],_features:[],_items:[],init:function(b){this._connection=b;this._identities=[];this._features=[];this._items=[];b.addHandler(this._onDiscoInfo.bind(this),Strophe.NS.DISCO_INFO,"iq","get",null,null);b.addHandler(this._onDiscoItems.bind(this),Strophe.NS.DISCO_ITEMS,"iq","get",null,null)},addIdentity:function(b,f,h,q){for(var u=0;u<this._identities.length;u++)if(this._identities[u].category==b&&this._identities[u].type==f&&this._identities[u].name==
h&&this._identities[u].lang==q)return!1;this._identities.push({category:b,type:f,name:h,lang:q});return!0},addFeature:function(b){for(var f=0;f<this._features.length;f++)if(this._features[f]==b)return!1;this._features.push(b);return!0},addItem:function(b,f,h,q){if(h&&!q)return!1;this._items.push({jid:b,name:f,node:h,call_back:q});return!0},info:function(b,f,h,q){var u={xmlns:Strophe.NS.DISCO_INFO};f&&(u.node=f);b=$iq({from:this._connection.jid,to:b,type:"get"}).c("query",u);this._connection.sendIQ(b,
h,q)},items:function(b,f,h,q){var u={xmlns:Strophe.NS.DISCO_ITEMS};f&&(u.node=f);b=$iq({from:this._connection.jid,to:b,type:"get"}).c("query",u);this._connection.sendIQ(b,h,q)},_onDiscoInfo:function(b){var f=b.getAttribute("id"),h=b.getAttribute("from"),q=b.getElementsByTagName("query")[0].getAttribute("node");b={xmlns:Strophe.NS.DISCO_INFO};q&&(b.node=q);f=$iq({type:"result",id:f,to:h}).c("query",b);for(h=0;h<this._identities.length;h++)b={category:this._identities[h].category,type:this._identities[h].type},
this._identities[h].name&&(b.name=this._identities[h].name),this._identities[h].lang&&(b["xml:lang"]=this._identities[h].lang),f.c("identity",b).up();for(h=0;h<this._features.length;h++)f.c("feature",{"var":this._features[h]}).up();this._connection.send(f.tree())},_onDiscoItems:function(b){var f=b.getAttribute("id"),h=b.getAttribute("from"),q={xmlns:Strophe.NS.DISCO_ITEMS},u=b.getElementsByTagName("query")[0].getAttribute("node");if(u){q.node=u;for(var v=null,x=0;x<this._items.length;x++)if(this._items[x].node==
u){v=this._items[x].call_back(b);break}}else v=this._items;b=$iq({type:"result",id:f,to:h}).c("query",q);for(x=0;x<v.length;x++)f={jid:v[x].jid},v[x].name&&(f.name=v[x].name),v[x].node&&(f.node=v[x].node),b.c("item",f).up();this._connection.send(b.tree())}});Ext.ns("Application");
Application.LoginPanel=Ext.extend(Ext.Panel,{initComponent:function(){this.items=[{html:'<img src="../images/nws.png" width="100"/>',height:105,width:105},{xtype:"panel",autoShow:!0,el:"myloginform",layout:"form",id:"myform",width:276,labelWidth:76,defaultType:"textfield",defaults:{allowBlank:!1},items:[{anchor:"100%",el:"username",id:"username",autoShow:!0,fieldLabel:"Username"},{anchor:"100%",el:"password",id:"password",autoShow:!0,fieldLabel:"Password",listeners:{specialkey:function(b,f){f.getKey()===
f.ENTER&&(Application.doLogin(),f.stopEvent())}}}],buttons:[{text:"Show Debug",handler:function(){Ext.getCmp("debug").show()}},{text:"Browser Save Login",handler:function(b,f){Ext.get("submit").dom.click()}},{text:"Login",handler:Application.doLogin}]},{xtype:"panel",colspan:2,contentEl:"loginmessage",preventBodyReset:!0}];Ext.apply(this,Ext.apply(this.initialConfig,{autoScroll:!0,title:"Login with Account",layout:"table",layoutConfig:{columns:2}}));Application.LoginPanel.superclass.initComponent.apply(this,
arguments)},addMessage:function(b){Application.msgtpl.insertFirst(this.items.items[2].body,{msg:b,date:new Date})}});Ext.namespace("Application");
Application.TabLoginPanel=Ext.extend(Ext.TabPanel,{initComponent:function(){Ext.apply(this,Ext.apply(this.initialConfig,{width:420,height:250,autoScroll:!0}));Application.TabLoginPanel.superclass.initComponent.apply(this,arguments);this.buildItems()},buildItems:function(){Application.LOGIN_OPT_USER&&this.add(new Application.LoginPanel({id:"loginpanel"}));Application.LOGIN_OPT_ANONYMOUS&&this.add({xtype:"panel",contentEl:"anonymous_div",preventBodyReset:!0,title:"Anonymous Login"});Application.LOGIN_OPT_REGISTER&&
this.add({xtype:"panel",contentEl:"register_div",preventBodyReset:!0,title:"Register Account"});this.activate(0)}});Ext.reg("tabloginpanel",Application.TabLoginPanel);Ext.ns("Application");
Application.DebugWindow=Ext.extend(Ext.Window,{initComponent:function(){this.items=[{xtype:"panel",title:"Debug Log",html:"<p>Browser CodeName: "+navigator.appCodeName+"</p><p>Browser Name: "+navigator.appName+"</p><p>Browser Version: "+navigator.appVersion+"</p><p>Cookies Enabled: "+navigator.cookieEnabled+"</p><p>Platform: "+navigator.platform+"</p><p>User-agent header: "+navigator.userAgent+"</p>",autoScroll:!0}];this.tbar=[{text:"Click to send this log to developer!",icon:"icons/print.png",scope:this,
handler:function(){Ext.Ajax.request({url:"bug.php",method:"POST",success:function(b){alert(b.responseText)},failure:function(){},headers:{"my-header":"foo"},params:{data:this.items.items[0].body.dom.innerHTML,user:Application.USERNAME}})}},{text:"Clear Log",icon:"icons/close.png",handler:function(){this.items.items[0].update("")},scope:this}];Ext.apply(this,Ext.apply(this.initialConfig,{width:600,height:300,title:"Debug Window",closeAction:"hide",hidden:!0,autoScroll:!0,layout:"fit"}));Application.DebugWindow.superclass.initComponent.apply(this,
arguments)},addMessage:function(b){Application.msgtpl.append(this.items.items[0].body,{msg:b,date:new Date})}});Ext.ns("Application");
Application.MUCChatPanel=Ext.extend(Ext.Panel,{hideMode:"offsets",closable:!0,layout:"border",chatType:"groupchat",barejid:null,handle:null,anonymous:null,joinedChat:!1,initComponent:function(){this.items=[{xtype:"chatgridpanel",region:"center"},{xtype:"chattextentry",region:"south",height:50,split:!0}];"allchats"!=this.initialConfig.chatType?(this.items.push({xtype:"mucroomusers",region:"east",width:175,collapsible:!0,split:!0}),this.iconCls="tabno"):this.items[1].emptyText="Type message here";Ext.apply(this,
Ext.apply(this.initialConfig,{listeners:{activate:function(b){b.iconCls&&b.setIconCls("tabno")},deactivate:function(b){b.iconCls&&b.setIconCls("tabno")}}}));Application.MUCChatPanel.superclass.initComponent.apply(this,arguments);this.buildItems()},clearRoom:function(){this.gp.getStore().removeAll();this.roomusers.root.removeAll()},getJidByHandle:function(b){b=this.roomusers.root.findChild("text",b);return null==b||Strophe.getDomainFromJid(b.attributes.jid)==Application.XMPPMUCHOST?null:b.attributes.jid},
buildItems:function(){this.gp=this.items.items[0];this.te=this.items.items[1];if("allchats"==this.chatType)this.gp.toolbars[0].items.items[4].disable(),this.gp.soundOn=!1,this.te.items.items[1].setText("To Room?");else{this.roomusers=this.items.items[2];new Ext.tree.TreeSorter(this.roomusers,{folderSort:!0,dir:"asc",property:"text"});this.anonymous&&this.te.disable();var b="muc::"+Strophe.getNodeFromJid(this.barejid)+"::mute";Application.getPreference(b,!1)&&(this.gp.toolbars[0].items.items[4].toggle(!0,
!0),this.gp.toolbars[0].items.items[4].setText("Sounds Muted"),this.gp.soundOn=!1);b="muc::"+Strophe.getNodeFromJid(this.barejid)+"::nwsbothidden";Application.getPreference(b,!1)&&(this.gp.toolbars[0].items.items[3].toggle(!0,!0),this.gp.toolbars[0].items.items[3].setText("NWSBot Hidden"),this.gp.store.filterBy(nwsbotFilter))}}});Ext.reg("mucchatpanel",Application.MUCChatPanel);Ext.ns("Application");
Application.MUCRoomUsers=Ext.extend(Ext.tree.TreePanel,{bodyStyle:{"margin-left":"-15px"},title:"0 people in room",rootVisible:!1,lines:!1,autoScroll:!0,initComponent:function(){this.root={text:"test",listeners:{append:function(f,h){sz=h.childNodes.length;f.setTitle(sz+" people in room")},remove:function(f,h){sz=h.childNodes.length;f.setTitle(sz+" people in room")}}};var b={plugins:new Ext.ux.DataTip({tpl:"<div>JID: {jid}<br />Affiliation: {affiliation}<br />Role: {role}</div>",constrainPosition:!0}),
listeners:{click:function(f){if(f.attributes.jid&&(username=Strophe.getNodeFromJid(f.attributes.jid),username!=Application.USERNAME)){var h=f.attributes.jid;Strophe.getDomainFromJid(f.attributes.jid)==Application.XMPPHOST&&(h=Strophe.getBareJidFromJid(f.attributes.jid));Application.log("Wish to start chat with:"+h);(cp=Ext.getCmp("chatpanel").getChat(h))||(cp=Ext.getCmp("chatpanel").addChat(h));Ext.getCmp("chatpanel").setActiveTab(cp)}}}};Ext.apply(this,Ext.apply(this.initialConfig,b));Application.MUCRoomUsers.superclass.initComponent.apply(this,
arguments);this.buildItems()},buildItems:function(){}});Ext.reg("mucroomusers",Application.MUCRoomUsers);Ext.ns("Application");Application.colors="000000 666666 D51460 FF0000 993333 FF9900 005500 009900 00DD00 0066CC 3399FF 0000FF 6666FF".split(" ");Application.colorpointer=0;Application.UserColorStore=new Ext.data.Store({fields:["user","color"]});
Application.getUserColor=function(b){idx=Application.UserColorStore.find("user",b);-1==idx?(c=Application.colors[Application.colorpointer],Application.UserColorStore.add(new Ext.data.Record({user:b,color:c})),Application.colorpointer++,12<Application.colorpointer&&(Application.colorpointer=0)):c=Application.UserColorStore.getAt(idx).get("color");return c};Ext.ns("Application");
Application.msgFormatter=new Ext.XTemplate('<p class="mymessage">',"<span ",'<tpl if="values.me == values.author">','class="author-me"',"</tpl>",'<tpl if="values.me != values.author">','class="{[this.getAuthorClass(values.jid)]}" style="color: #{[Application.getUserColor(values.author)]};"',"</tpl>",">(",'<tpl if="this.isNotToday(ts)">','{ts:date("d M")} ',"</tpl>",'{ts:date("g:i A")}) ','<tpl if="values.room != null">',"[{room}] ","</tpl>","{author}:</span> ","{message}</p>",{isNotToday:function(b){return(new Date).format("md")!=
b.format("md")},getAuthorClass:function(b){return null==b?"author-default":"nwsbot"==Strophe.getNodeFromJid(b)?"author-nwsbot":Strophe.getNodeFromJid(b).match(/^nws/)?"author-nws":"author-chatpartner"}});
Application.ChatGridPanel=Ext.extend(Ext.grid.GridPanel,{region:"center",soundOn:!0,nwsbotHide:!1,stripeRows:!0,autoExpandColumn:"message",autoScroll:!0,tbar:[{text:"Clear Room Log",cls:"x-btn-text-icon",icon:"icons/close.png",handler:function(b,f){b.ownerCt.ownerCt.getStore().removeAll()}},{text:"Print Log",icon:"icons/print.png",cls:"x-btn-text-icon",handler:function(b,f){b.ownerCt.ownerCt.getGridEl().print({isGrid:!0})}},{text:"View As HTML",handler:function(b,f){showHtmlVersion(b.ownerCt.ownerCt)},
icon:"icons/text.png",cls:"x-btn-text-icon"},{text:"Hide NWSBot",enableToggle:!0,toggleHandler:function(b,f){var h="muc::"+Strophe.getNodeFromJid(b.ownerCt.ownerCt.ownerCt.barejid)+"::nwsbothidden",q=b.ownerCt.ownerCt.getStore();(b.ownerCt.ownerCt.nwsbotHide=f)?(Application.setPreference(h,"true"),q.filterBy(nwsbotFilter),b.setText("NWSBot Hidden")):(Application.removePreference(h),q.clearFilter(!1),b.setText("Hide NWSBot"))}},{text:"Mute Sounds",enableToggle:!0,toggleHandler:function(b,f){var h=
"muc::"+Strophe.getNodeFromJid(b.ownerCt.ownerCt.ownerCt.barejid)+"::mute";f?(Application.setPreference(h,"true"),b.ownerCt.ownerCt.soundOn=!1,b.setText("Sounds Muted")):(Application.removePreference(h),b.ownerCt.ownerCt.soundOn=!0,b.setText("Mute Sounds"))}},{icon:"icons/font-less.png",handler:function(){var b=parseInt(Application.getPreference("font-size",14))-2;Application.setPreference("font-size",b);cssfmt=String.format("normal {0}px arial",b);Ext.util.CSS.updateRule("td.x-grid3-td-message",
"font",cssfmt);Ext.util.CSS.updateRule(".message-entry-box","font",cssfmt)}},{icon:"icons/font-more.png",handler:function(){var b=parseInt(Application.getPreference("font-size",14))+2;Application.setPreference("font-size",b);cssfmt=String.format("normal {0}px arial",b);Ext.util.CSS.updateRule("td.x-grid3-td-message","font",cssfmt);Ext.util.CSS.updateRule(".message-entry-box","font",cssfmt)}}],initComponent:function(){this.columns=[{header:"Author",sortable:!0,dataIndex:"author",hidden:!0},{id:"message",
header:"Message",sortable:!0,dataIndex:"ts",scope:this,renderer:function(f,h,q){return Application.msgFormatter.apply({author:q.get("author"),message:q.get("message"),ts:q.get("ts"),room:q.get("room"),jid:q.get("jid"),me:this.ownerCt.handle})}}];this.store=new Ext.data.ArrayStore({sortInfo:{field:"ts",direction:"ASC"},fields:[{name:"ts",type:"date"},"author","message","product_id","jid","room",{name:"xdelay",type:"boolean"}]});this.store.on("add",function(f,h,q){if(!this.soundOn)return!0;f=!1;q=!0;
for(var u=0;u<h.length;u++)h[u].get("xdelay")||h[u].get("author")==this.ownerCt.handle||("nwsbot"!=h[u].get("author")&&(f=!0),h[u].get("message").match(/tornado/i)&&Application.MsgBus.fireEvent("soundevent","tornado"),h[u].get("message").match(this.ownerCt.handle)&&Application.MsgBus.fireEvent("soundevent","myhandle"),q=!1);if(q)return!0;f?(this.ownerCt.setIconCls("new-tab"),Application.MsgBus.fireEvent("soundevent","new_message")):this.nwsbotHide||(this.ownerCt.setIconCls("new-tab"),Application.MsgBus.fireEvent("soundevent",
"nwsbot"))},this);var b={viewConfig:{onAdd:function(f,h,q){this.constructor.prototype.onAdd.apply(this,arguments);(row=this.grid.getView().getRow(q))&&row.scrollIntoView()},templates:{cell:new Ext.Template('<td class="x-grid3-col x-grid3-cell x-grid3-td-{id} x-selectable {css}" style="{style}"  tabIndex="0" {cellAttr}>','<div class="x-grid3-cell-inner x-grid3-col-{id}" {attr}>{value}</div>',"</td>")}},sm:new Ext.grid.RowSelectionModel({listeners:{rowselect:function(f,h,q){q.data.product_id&&(Application.TextWindow.show(),
Application.TextWindow.load({params:{pid:q.data.product_id,bypass:1},text:"Loading...",method:"GET",url:"../p.php"}))}}}),listeners:{render:function(f){f.getView().mainBody.on("mousedown",function(h,q){"A"==q.tagName&&(h.stopEvent(),q.target="_blank")});f.body.on({mousedown:function(h,q){q.target="_blank";Application.TextWindow.hide()},click:function(h,q){"_blank"!=String(q.target).toLowerCase()&&(h.stopEvent(),window.open(q.href));Application.TextWindow.hide()},delegate:"a"})}}};Ext.apply(this,b);
Application.ChatGridPanel.superclass.initComponent.apply(this,arguments)}});Ext.reg("chatgridpanel",Application.ChatGridPanel);Ext.ns("Application");
Application.ChatTextEntry=Ext.extend(Ext.Panel,{layout:"hbox",layoutConfig:{align:"stretch"},border:!1,chatstate:null,initComponent:function(){this.items=[{xtype:"textarea",flex:1,cls:"message-entry-box",autoCreate:{tag:"textarea",style:'rows:10;cols:72;wrap:"hard";',autocomplete:"off"},style:{background:"#"+Application.getPreference("bgcolor","FFFFFF"),color:"#"+Application.getPreference("fgcolor","000000")},enableKeyEvents:!0,listeners:{keyup:function(b,f){if(f.getKey()===f.ENTER&&!f.shiftKey)return this.chatstate&&
this.chatstate.cancel(),this.chatstate=null,this.ownerCt.getComponent(1).handler(),!0;"chat"==this.ownerCt.ownerCt.chatType&&(this.chatstate||(this.chatstate=new Ext.util.DelayedTask(function(){this.ownerCt&&this.ownerCt.ownerCt&&(Application.XMPPConn.send($msg({to:this.ownerCt.ownerCt.barejid,type:this.ownerCt.ownerCt.chatType}).c("paused",{xmlns:"http://jabber.org/protocol/chatstates"})),this.chatstate=null)},this),Application.XMPPConn.send($msg({to:this.ownerCt.ownerCt.barejid,type:this.ownerCt.ownerCt.chatType}).c("composing",
{xmlns:"http://jabber.org/protocol/chatstates"}))),this.chatstate.delay(5E3))},render:{delay:500,fn:function(){this.focus()}}}},{xtype:"button",text:"Send",width:60,popup:null,handler:function(){var b=this.ownerCt.getComponent(0),f=b.getValue().trim();if(0===f.length)return b.focus(),!1;var h=Application.getPreference("bgcolor","FFFFFF"),q=Application.getPreference("fgcolor","000000");if("allchats"==this.ownerCt.ownerCt.chatType)b.emptyText="",b.setValue(""),(new Application.AllChatMessageWindow({message:Application.replaceURLWithHTMLLinks(f)})).show();
else{for(var u=$.parseHTML(Application.replaceURLWithHTMLLinks(f)),v=$msg({to:this.ownerCt.ownerCt.barejid,type:this.ownerCt.ownerCt.chatType}).c("active",{xmlns:"http://jabber.org/protocol/chatstates"}).up().c("body").t(f).up().c("html",{xmlns:"http://jabber.org/protocol/xhtml-im"}).c("body",{xmlns:"http://www.w3.org/1999/xhtml"}).c("p").c("span",{style:"color:#"+q+";background:#"+h+";"}),x=0;x<u.length;x++)v=v.cnode(u[x]),x<u.length&&(v=v.up());Application.XMPPConn.send(v);b.setValue("");b.focus();
"chat"==this.ownerCt.ownerCt.chatType&&(f="<span style='color:#"+q+";background:#"+h+";'>"+f+"</span>",this.ownerCt.ownerCt.gp.getStore().addSorted(new Ext.data.Record({ts:new Date,author:Application.USERNAME,message:Application.replaceURLWithHTMLLinks(f)})))}}}];Application.ChatTextEntry.superclass.initComponent.apply(this,arguments)}});Ext.reg("chattextentry",Application.ChatTextEntry);Ext.ns("Application");
Application.ChatPanel=Ext.extend(Ext.Panel,{hideMode:"offsets",closable:!0,layout:"border",iconCls:"tabno",chatType:"chat",barejid:null,handle:null,anonymous:null,initComponent:function(){this.items=[new Application.ChatGridPanel({region:"center"}),new Application.ChatTextEntry({region:"south",height:50,split:!0})];Ext.apply(this,Ext.apply(this.initialConfig,{listeners:{activate:function(b){b.setIconCls("tabno")},deactivate:function(b){b.setIconCls("tabno")},beforedestroy:function(b){b.te.chatstate&&b.te.chatstate.cancel();
Application.XMPPConn.send($msg({to:b.barejid,type:b.chatType}).c("gone",{xmlns:"http://jabber.org/protocol/chatstates"}))}}}));Application.ChatPanel.superclass.initComponent.apply(this,arguments);this.buildItems()},getJidByHandle:function(b){return this.barejid},buildItems:function(){this.gp=this.items.items[0];this.te=this.items.items[1];this.gp.getTopToolbar().remove(this.gp.getTopToolbar().items.items[3]);this.gp.getTopToolbar().remove(this.gp.getTopToolbar().items.items[3])}});
Ext.reg("chatpanel",Application.ChatPanel);Ext.ns("Application");
Application.LiveViewport=Ext.extend(Ext.Viewport,{initComponent:function(){var b={xtype:"panel",region:"north",height:10,hidden:!0,title:"Map Disabled by URL"};this.initialConfig.enableMap&&(b={xtype:"panel",layout:"border",region:"north",collapsible:!0,title:"Map Panel",height:300,split:!0,items:[Application.MapPanel,Application.LayerTree]});this.items=[Application.Control,{xtype:"panel",region:"center",layout:"border",items:[b,new Application.ChatTabPanel({id:"chatpanel",region:"center",split:!0})]}];
Ext.apply(this,Ext.apply(this.initialConfig,{layout:"border"}));Application.LiveViewport.superclass.initComponent.call(this);this.doStuff()},doStuff:function(){var b=Ext.getCmp("map");b&&(b.map.events.register("changelayer",null,function(f){f={lstring:""};Application.layerstore.data.each(function(h){h=h.getLayer();h.getVisibility()&&(this.lstring+="||"+h.name)},f);Application.setPreference("layers",f.lstring)}),Ext.TaskMgr.start(Application.MapTask));new Application.DebugWindow({id:"debug",renderTo:Ext.getBody()});
(new Ext.Window({id:"loginwindow",modal:!0,closable:!1,title:"Weather.IM Live Login Options",items:[new Application.TabLoginPanel]})).show()}});Ext.ns("Application");Application.MapLegend=Ext.extend(Ext.Window,{width:300,height:200,autoScroll:!0,title:"Map Legends",hidden:!0,closeAction:"hide",initComponent:function(){Ext.apply(this,Ext.apply(this.initialConfig,{}));Application.MapLegend.superclass.initComponent.apply(this,arguments);this.buildItems()},buildItems:function(){}});/*
 Ext JS Library 3.3.1
 Copyright(c) 2006-2010 Sencha Inc.
 licensing@sencha.com
 http://www.sencha.com/license
*/
Ext.ns("Ext.ux.grid");Ext.ux.grid.CheckColumn=Ext.extend(Ext.grid.Column,{processEvent:function(b,f,h,q,u){if("mousedown"==b){var v=h.store.getAt(q);v.set(this.dataIndex,!v.data[this.dataIndex]);return!1}return Ext.grid.ActionColumn.superclass.processEvent.apply(this,arguments)},renderer:function(b,f,h){f.css+=" x-grid3-check-col-td";return String.format('<div class="x-grid3-check-col{0}">&#160;</div>',b?"-on":"")},init:Ext.emptyFn});Ext.preg("checkcolumn",Ext.ux.grid.CheckColumn);
Ext.grid.CheckColumn=Ext.ux.grid.CheckColumn;Ext.grid.Column.types.checkcolumn=Ext.ux.grid.CheckColumn;Ext.ux.DataTip=Ext.extend(Ext.ToolTip,function(){function b(){var y=this.body||this.el;this.dataTip.renderToTarget&&this.dataTip.render(y);this.dataTip.initTarget(y)}function f(y,z){y.rendered?y.update(z):Ext.isString(z)?y.html=z:y.data=z}function h(y){var z=Ext.fly(y.triggerElement).findParent("div.x-tree-node-el",null,!0);if(z=z?y.host.getNodeById(z.getAttribute("tree-node-id","ext")):null)f(y,z.attributes);else return!1}function q(y){var z=this.host.getStore().getAt(this.host.getView().findRowIndex(y.triggerElement));
if(z)f(y,z.data);else return!1}function u(y){var z=this.host.getRecord(y.triggerElement);if(z)f(y,z.data);else return!1}function v(y){var z=Ext.fly(y.triggerElement).child("input,textarea");if((z=z?this.host.getForm().findField(z.id):null)&&(z.tooltip||y.tpl))f(y,z.tooltip||z);else return!1}function x(y){var z=this.host.store.getAt(this.host.selectedIndex);if(z)f(y,z.data);else return!1}return{init:function(y){y.dataTip=this;this.host=y;y instanceof Ext.tree.TreePanel?(this.delegate=this.delegate||
"div.x-tree-node-el",this.on("beforeshow",h)):y instanceof Ext.grid.GridPanel?(this.delegate=this.delegate||y.getView().rowSelector,this.on("beforeshow",q)):y instanceof Ext.DataView?(this.delegate=this.delegate||y.itemSelector,this.on("beforeshow",u)):y instanceof Ext.FormPanel?(this.delegate="div.x-form-item",this.on("beforeshow",v)):y instanceof Ext.form.ComboBox&&(this.delegate=this.delegate||y.itemSelector,this.on("beforeshow",x));y.rendered?b.call(y):y.onRender=y.onRender.createSequence(b)}}}());Ext.ns("Application");
function onBuddyPresence(b){var f=b.getAttribute("from"),h=Strophe.getBareJidFromJid(f),q=Strophe.getResourceFromJid(f),u=Strophe.getNodeFromJid(f),v="Available";u==Application.USERNAME&&q!=Application.XMPPRESOURCE&&q.match(/^WeatherIM/)&&("unavailable"==b.getAttribute("type")?Application.log("Self presence: ["+u+"] ["+q+"] unavailable"):Application.log("Self presence: ["+u+"] ["+q+"] available"));0<$(b).find("status").length&&(v=$(b).find("status").text());"subscribe"==b.getAttribute("type")?Ext.Msg.show({title:"New Buddy Request",
msg:"User "+u+" wishes to add you as a buddy. Is this okay?",buttons:Ext.Msg.YESNO,fn:function(x){"yes"==x?(x=$pres({to:f,type:"subscribed"}),Application.XMPPConn.send(x.tree()),Application.buildAddBuddy(u,u,"Buddies")):(x=$pres({to:f,type:"unsubscribed"}),Application.XMPPConn.send(x.tree()))},icon:Ext.MessageBox.QUESTION}):Ext.getCmp("buddies").root.eachChild(function(x){x.eachChild(function(y){y.attributes.barejid==h&&(((res=y.attributes.resources.get(q))||y.attributes.resources.add(q,{status:v,
resource:q}),b.getAttribute("type"))?"unavailable"==b.getAttribute("type")&&(1==y.attributes.resources.length&&(y.attributes.presence="offline",y.setIconCls("buddy-offline"),y.ui.hide()),y.attributes.resources.remove(q)):(0<$(b).find("show").length?y.setIconCls("buddy-away"):y.setIconCls("buddy-online"),y.attributes.presence="online",y.ui.show(),y.attributes.resources.replace(q,{status:v,resource:q})))})})};Ext.ns("Application");
Application.AllChatMessageWindow=Ext.extend(Ext.Window,{title:"Where to send this message?",width:460,height:300,modal:!0,layout:"form",layoutConfig:{},defaults:{width:450},initComponent:function(){this.buttons=[{text:"Send Message",scope:this,handler:function(){var b=this.find("name","columns")[0];Ext.each(b.findByType("checkbox"),function(f){f.checked&&Application.XMPPConn.send($msg({to:f.name+"@"+Application.XMPPMUCHOST,type:"groupchat"}).c("body").t(this.message).up().c("html",{xmlns:"http://jabber.org/protocol/xhtml-im"}).c("body",
{xmlns:"http://www.w3.org/1999/xhtml"}).c("p").c("span",{style:"color:#"+Application.getPreference("fgcolor","000000")+";background:#"+Application.getPreference("bgcolor","FFFFFF")+";"}).t(this.message))},this);this.close()}},{text:"Cancel",handler:function(){this.ownerCt.ownerCt.close()}}];Application.AllChatMessageWindow.superclass.initComponent.apply(this,arguments);this.buildItems(this.message);this.addAvailableRooms()},addAvailableRooms:function(){Ext.getCmp("chatpanel").items.each(function(b){if("groupchat"==
b.chatType&&!b.anonymous&&(b=Strophe.getNodeFromJid(b.barejid),0==this.items.items[1].find("name",b).length)){var f=this.find("name","columns")[0];pos=f.entries%3;f.items.items[pos].add({xtype:"checkbox",hideLabel:!0,boxLabel:b,name:b});f.entries+=1}},this)},buildItems:function(b){this.add({xtype:"textarea",hideLabel:!0,html:b});this.add({xtype:"fieldset",title:"Send my message to the following room(s):",autoHeight:!0,autoScroll:!0,items:[{entries:0,name:"columns",layout:"table",items:[{layout:"form",
border:!1,colname:"col1",width:140,items:[]},{layout:"form",border:!1,colname:"col2",width:140,items:[]},{width:140,border:!1,colname:"col3",layout:"form",items:[]}]}]})}});/*
 Licensed under the terms of the Open Source <a href="http://www.gnu.org/licenses/lgpl.html">LGPL 3.0 license</a>. Commercial use is permitted to the extent that the code/component(s) do NOT become part of another Open Source or Commercially licensed development library or toolkit without explicit permission.
 @version 2.0.0 (Feb 14, 2010)
*/
Ext.namespace("Ext.ux.panel");
Ext.ux.panel.DDTabPanel=Ext.extend(Ext.TabPanel,{arrowOffsetX:-9,arrowOffsetY:-8,initComponent:function(){Ext.ux.panel.DDTabPanel.superclass.initComponent.call(this);this.addEvents("reorder");this.ddGroupId||(this.ddGroupId="dd-tabpanel-group-"+Ext.ux.panel.DDTabPanel.superclass.getId.call(this))},reorder:function(b){this.fireEvent("reorder",this,b)},afterRender:function(){Ext.ux.panel.DDTabPanel.superclass.afterRender.call(this);this.arrow=Ext.DomHelper.append(Ext.getBody(),'<div class="dd-arrow-down"></div>',
!0);this.arrow.hide();this.dd=new Ext.ux.panel.DDTabPanel.DropTarget(this,{ddGroup:this.ddGroupId});this.move=!1},initTab:function(b,f){Ext.ux.panel.DDTabPanel.superclass.initTab.call(this,b,f);f=this.id+"__"+b.id;Ext.fly(f).on("click",function(){b.ownerCt.setActiveTab(b.id)});Ext.applyIf(b,{allowDrag:!0});Ext.apply(b,{ds:new Ext.dd.DragSource(f,{ddGroup:this.ddGroupId,dropEl:b,dropElHeader:Ext.get(f,!0),scroll:!1,onStartDrag:function(){if(this.dropEl.iconCls){var h=this.getProxy().getGhost().select(".x-tab-strip-text");
h.addClass("x-panel-inline-icon");var q=h.elements[0].innerHTML;q=Ext.util.Format.stripTags(q);h.elements[0].innerHTML=q;h.applyStyles({paddingLeft:"20px"})}},onMouseUp:function(h){this.dropEl.ownerCt.move?(this.dropEl.disabled||null!=this.dropEl.ownerCt.activeTab||this.dropEl.ownerCt.setActiveTab(this.dropEl),this.dropEl.ownerCt.move=!1):this.dropEl.isVisible()||this.dropEl.disabled||this.dropEl.show()}}),enableTabDrag:function(){this.allowDrag=!0;return this.ds.unlock()},disableTabDrag:function(){this.allowDrag=
!1;return this.ds.lock()}});b.allowDrag?b.enableTabDrag():b.disableTabDrag()},onRemove:function(b){var f=Ext.get(b.tabEl);f&&(f.select("a").removeAllListeners(),Ext.destroy(f));Ext.TabPanel.superclass.onRemove.call(this,b);this.stack.remove(b);delete b.tabEl;b.un("disable",this.onItemDisabled,this);b.un("enable",this.onItemEnabled,this);b.un("titlechange",this.onItemTitleChanged,this);b.un("iconchange",this.onItemIconChanged,this);b.un("beforeshow",this.onBeforeShowItem,this);b==this.activeTab&&(this.move?
this.activeTab=null:(b=this.stack.next())?this.setActiveTab(b):0<this.items.getCount()?this.setActiveTab(0):this.activeTab=null);this.destroying||this.delegateUpdates()},onDestroy:function(){Ext.destroy(this.dd,this.arrow);Ext.ux.panel.DDTabPanel.superclass.onDestroy.call(this)}});
Ext.ux.panel.DDTabPanel.DropTarget=Ext.extend(Ext.dd.DropTarget,{constructor:function(b,f){this.tabpanel=b;Ext.ux.panel.DDTabPanel.DropTarget.superclass.constructor.call(this,b.stripWrap,f)},notifyOver:function(b,f,h){var q=this.tabpanel.items,u=q.length;if(!f.within(this.getEl())||b.dropEl==this.tabpanel)return"x-dd-drop-nodrop";h=this.tabpanel.arrow;var v=this.el.getY();f=f.getPageX();for(var x=0;x<u;x++){var y=z;var z=q.itemAt(x);var N=z.ds.dropElHeader,F=N.getX();if(f<=F+N.dom.clientWidth/2){var G=
F;break}}if("undefined"==typeof G){G=q.itemAt(u-1);if(G==b.dropEl)return"x-dd-drop-nodrop";b=G.ds.dropElHeader.dom;G=(new Ext.Element(b)).getX()+b.clientWidth+3}else if(z==b.dropEl||y==b.dropEl)return this.tabpanel.arrow.hide(),"x-dd-drop-nodrop";h.setTop(v+this.tabpanel.arrowOffsetY).setLeft(G+this.tabpanel.arrowOffsetX).show();return"x-dd-drop-ok"},notifyDrop:function(b,f,h){this.tabpanel.arrow.hide();if(b.dropEl==this.tabpanel)return!1;h=this.tabpanel.items;var q=f.getPageX();for(f=0;f<h.length;f++){var u=
h.itemAt(f),v=u.ds.dropElHeader;v=v.getX()+v.dom.clientWidth/2;if(q<=v)break}if(u==b.dropEl||h.itemAt(f-1)==b.dropEl)return!1;b.proxy.hide();b.dropEl.ownerCt==this.tabpanel&&f>h.indexOf(b.dropEl)&&f--;this.tabpanel.move=!0;b=b.dropEl.ownerCt.remove(b.dropEl,!1);this.tabpanel.insert(f,b);this.tabpanel.fireEvent("drop",this.tabpanel);this.tabpanel.reorder(h.itemAt(f));return!0},notifyOut:function(b,f,h){this.tabpanel.arrow.hide()}});Ext.reg("ddtabpanel",Ext.ux.panel.DDTabPanel);Ext.ns("Application");
Application.ChatTabPanel=Ext.extend(Ext.ux.panel.DDTabPanel,{activeTab:0,deferredRender:!1,split:!0,enableTabScroll:!0,initComponent:function(){Ext.apply(this,Ext.apply(this.initialConfig,{}));Application.ChatTabPanel.superclass.initComponent.apply(this,arguments);this.buildItems()},buildItems:function(){this.add({contentEl:"help",title:"Help",preventBodyReset:!0,style:{margin:"5px"},autoScroll:!0});this.add(new Application.MUCChatPanel({title:"All Chats",closable:!1,chatType:"allchats",barejid:"__allchats__@"+
Application.XMPPMUCHOST,id:"__allchats__"}))},addMUC:function(b,f,h){b=new Application.MUCChatPanel({title:Strophe.getNodeFromJid(b),barejid:b,handle:f,anonymous:h});return this.add(b)},getMUC:function(b){return this.find("barejid",b)[0]},removeMUC:function(b){this.remove(this.getMUC(b))},addChat:function(b){var f=Strophe.getNodeFromJid(b);Strophe.getDomainFromJid(b)==Application.XMPPMUCHOST&&(f=Strophe.getResourceFromJid(b));b=new Application.ChatPanel({title:f,handle:Application.USERNAME,barejid:b});
return this.add(b)},getChat:function(b){return this.find("barejid",b)[0]},removeChat:function(b){this.remove(this.getChat(b))}});Ext.reg("chattabpanel",Application.ChatTabPanel);Ext.ns("Application");function nwsbotFilter(b,f){return"nwsbot"==b.get("author")?!1:!0}
function grid2html(b){var f=b.getStore();b=b.ownerCt.title;t="<html><head></head><body>";t+="<table cellpadding='2' cellspacing='0' border='1'><tr><th>Roomname</th><th>Date</th><th>Author</th><th>Message</th></tr>";for(var h=0;h<f.getCount();h++)row=f.getAt(h),t+=String.format("<tr><td>{0}</td><td>{1}</td><td>{2}</td><td>{3}</td></tr>\r\n",row.get("roomname")||b,row.get("ts").format("Y/m/d g:i A"),row.get("author"),row.get("message"));return t+="</table></body></html>"}
function htmlExport(b){Ext.isIE6||Ext.isIE7||Ext.isSafari||Ext.isSafari2||Ext.isSafari3?Ext.Msg.alert("Status","Sorry, this tool does not work with this browser."):(t=grid2html(b),document.location="data:plain/html;base64,"+encode64(t))}function showHtmlVersion(b){(new Ext.Window({title:"Text Version",closable:!0,width:600,height:350,plain:!0,autoScroll:!0,html:grid2html(b)})).show()}
var LinkInterceptor={render:function(b){b.body.on({mousedown:function(f,h){h.target="_blank";Application.TextWindow.hide()},click:function(f,h){"_blank"!=String(h.target).toLowerCase()&&(f.stopEvent(),window.open(h.href));Application.TextWindow.hide()},delegate:"a"})}};Ext.ns("Application");Application.saveViews=function(){for(var b=$iq({type:"set",id:"_set1"}).c("query",{xmlns:"jabber:iq:private"}).c("storage",{xmlns:"nwschatlive:views"}),f=1;6>f;f++)(bnds=Ext.getCmp("mfv"+f).bounds)&&b.c("view",{label:Ext.getCmp("mfv"+f).getValue(),bounds:bnds.left+","+bnds.bottom+","+bnds.right+","+bnds.top}).up();Application.XMPPConn.sendIQ(b.tree())};Ext.util.Format.comboRenderer=function(b){return function(f){return(f=b.findRecord(b.valueField,f))?f.get(b.displayField):b.valueNotFoundText}};
Application.SoundStore=new Ext.data.ArrayStore({fields:["id","label","src"],data:[["default","Default","sounds/message_new.mp3"],["bleep","Bleep","sounds/bleep.mp3"],["cow","Cow (Mooo!)","sounds/cow.mp3"],["doorbell","Door Bell","sounds/doorbell.mp3"],["eas","EAS Beep","sounds/eas.mp3"],["elevator","Elevator","sounds/elevator.mp3"]]});
var combo=new Ext.form.ComboBox({typeAhead:!1,triggerAction:"all",lazyRender:!0,mode:"local",store:Application.SoundStore,listeners:{change:function(b,f,h){Application.playSound(f)}},valueField:"id",displayField:"label"});
Application.soundPrefs=new Ext.Window({title:"Sound Preferences",width:500,height:300,closeAction:"hide",layout:"form",buttons:[{text:"Save Sound Settings",handler:function(){Ext.getCmp("soundpanel").getStore().each(function(b){eidx=b.get("id");Application.setPreference("sound::"+eidx+"::enabled",b.get("enabled")?"true":"false");Application.setPreference("sound::"+eidx+"::sound",b.get("sound"))});Application.soundPrefs.hide();Application.syncPreferences()}}],items:[{xtype:"slider",id:"volume",minValue:0,
maxValue:100,value:50,width:200,listeners:{changecomplete:function(b,f,h){Application.setPreference("volume",f);Application.MsgBus.fireEvent("soundevent","default")}},fieldLabel:"Volume"},new Ext.grid.EditorGridPanel({store:new Ext.data.ArrayStore({data:[["new_message","New Message (Non NWSBot)",!0,"default"],["new_conversation","New Conversation",!0,"doorbell"],["nwsbot","NWSBot Message",!0,"default"],["myhandle","Message with your name in it",!0,"bleep"],["tornado",'Message with "Tornado" within text',
!0,"eas"]],fields:[{name:"id",type:"string"},{name:"label",type:"string"},{name:"enabled",type:"bool"},{name:"sound",type:"string"}],sortInfo:{field:"label",direction:"ASC"}}),cm:new Ext.grid.ColumnModel({columns:[{dataIndex:"enabled",id:"enabled",header:"Enable",xtype:"checkcolumn"},{dataIndex:"label",id:"label",sortable:!0,header:"Event Type"},{dataIndex:"sound",id:"sound",header:"Sound",renderer:Ext.util.Format.comboRenderer(combo),editor:combo}]}),id:"soundpanel",title:"Sound Events",frame:!0,
clicksToEdit:1,stripeRows:!0,autoExpandColumn:"label",height:200,autoScroll:!0})]});
Application.boundsFavorites=new Ext.Window({title:"Map View Favorites",width:500,height:300,closeAction:"hide",layout:"table",layoutConfig:{columns:4},autoScroll:!0,buttons:[{text:"Save Settings",handler:function(){for(var b=1;6>b;b++)nval=Ext.getCmp("mfv"+b).getValue(),""!=nval&&Ext.getCmp("fm"+b).setText(nval);Application.boundsFavorites.hide()}}],items:[{html:"This form allows you to modify the 5 allowed map extent favorites. The first favorite will be your default view when you log in and for the star icon above.",colspan:4},
{html:"#1"},{xtype:"textfield",id:"mfv1",bounds:null,width:200},{xtype:"button",text:"Set From Current View",handler:function(b,f){Ext.getCmp("mfv1").bounds=Ext.getCmp("map").map.getExtent();Application.saveViews()}},{xtype:"button",text:"View",handler:function(b,f){(bnds=Ext.getCmp("mfv1").bounds)&&Ext.getCmp("map").map.zoomToExtent(bnds,!0)}},{html:"#2"},{xtype:"textfield",id:"mfv2",bounds:null,width:200},{xtype:"button",text:"Set From Current View",handler:function(b,f){Ext.getCmp("mfv2").bounds=
Ext.getCmp("map").map.getExtent();Application.saveViews()}},{xtype:"button",text:"View",handler:function(b,f){(bnds=Ext.getCmp("mfv2").bounds)&&Ext.getCmp("map").map.zoomToExtent(bnds,!0)}},{html:"#3"},{xtype:"textfield",id:"mfv3",bounds:null,width:200},{xtype:"button",text:"Set From Current View",handler:function(b,f){Ext.getCmp("mfv3").bounds=Ext.getCmp("map").map.getExtent();Application.saveViews()}},{xtype:"button",text:"View",handler:function(b,f){(bnds=Ext.getCmp("mfv3").bounds)&&Ext.getCmp("map").map.zoomToExtent(bnds,
!0)}},{html:"#4"},{xtype:"textfield",id:"mfv4",bounds:null,width:200},{xtype:"button",text:"Set From Current View",handler:function(b,f){Ext.getCmp("mfv4").bounds=Ext.getCmp("map").map.getExtent();Application.saveViews()}},{xtype:"button",text:"View",handler:function(b,f){(bnds=Ext.getCmp("mfv4").bounds)&&Ext.getCmp("map").map.zoomToExtent(bnds,!0)}},{html:"#5"},{xtype:"textfield",id:"mfv5",bounds:null,width:200},{xtype:"button",text:"Set From Current View",handler:function(b,f){Ext.getCmp("mfv5").bounds=
Ext.getCmp("map").map.getExtent();Application.saveViews()}},{xtype:"button",text:"View",handler:function(b,f){(bnds=Ext.getCmp("mfv5").bounds)&&Ext.getCmp("map").map.zoomToExtent(bnds,!0)}}]});
mucform=new Ext.form.FormPanel({labelWidth:200,padding:5,items:[{xtype:"textfield",allowBlank:!1,name:"roomname",fieldLabel:"Room Name"},{xtype:"textfield",allowBlank:!1,name:"roomhandle",value:Application.USERNAME,fieldLabel:"Chat Handle"},{xtype:"checkbox",name:"bookmark",fieldLabel:"Save Bookmark for Chatroom?",handler:function(b,f){f?mucform.getForm().findField("roomalias").enable():mucform.getForm().findField("roomalias").disable()}},{xtype:"textfield",name:"roomalias",fieldLabel:"Bookmark Alias (optional)",
disabled:!0},{xtype:"checkbox",name:"anonymous",fieldLabel:"Anonymously Monitor (read-only)"},{xtype:"checkbox",name:"autojoin",fieldLabel:"Auto Join Room after Login"}],listeners:{render:function(){mucform.getForm().findField("roomhandle").getValue()||mucform.getForm().findField("roomhandle").setValue(Application.USERNAME)}}});var privform=new Ext.form.FormPanel({labelWidth:100,padding:5,items:[{xtype:"textfield",fieldLabel:"User Name",emptyText:"media-joe.blow",name:"username"}]});
Application.CreatePrivateChat=new Ext.Window({width:400,title:"Chat with User",items:[privform],buttons:[{xtype:"button",text:"Start Chat",scope:privform,handler:function(){var b=this.getForm().findField("username").getValue();-1==b.indexOf("@")&&(b=b+"@"+Application.XMPPHOST);Application.CreatePrivateChat.hide();(cp=Ext.getCmp("chatpanel").getChat(b))||(cp=Ext.getCmp("chatpanel").addChat(b));Ext.getCmp("chatpanel").setActiveTab(cp)}},{xtype:"button",text:"Cancel",handler:function(){Application.CreatePrivateChat.hide()}}]});
Application.JoinChatroomDialog=new Ext.Window({width:400,title:"Join a Group Chat",items:[mucform],buttons:[{xtype:"button",text:"Join Room",scope:mucform,handler:function(){roomname=this.getForm().findField("roomname").getValue();room=roomname+"@conference."+Application.XMPPHOST;handle=this.getForm().findField("roomhandle").getValue();ibook=this.getForm().findField("bookmark").getValue();anonymous=this.getForm().findField("anonymous").getValue();autojoin=this.getForm().findField("autojoin").getValue();
ibook&&(alias=this.getForm().findField("roomalias").getValue(),""==alias&&(alias=roomname),Ext.getCmp("bookmarks").root.appendChild({text:alias+" ("+roomname+")",jid:room,alias,anonymous,autojoin,icon:"icons/chat.png",handle,leaf:!0}));Application.MsgBus.fireEvent("joinchat",room,handle,anonymous);Application.JoinChatroomDialog.hide()}},{xtype:"button",text:"Cancel",handler:function(){Application.JoinChatroomDialog.hide()}}]});Application.msgtpl=new Ext.XTemplate('<p>{date:date("g:i:s A")} :: {msg}</p>');
Application.TextWindow=new Ext.Window({width:550,height:300,title:"Product Text",closeAction:"hide",constrain:!0,hidden:!0,autoScroll:!0,html:"Loading...."});Application.log=function(b){Ext.getCmp("debug").addMessage(b)};Ext.ns("Application");function saveBookmarks(){var b=Ext.getCmp("bookmarks").root,f=$iq({type:"set",id:"_set1"}).c("query",{xmlns:"jabber:iq:private"}).c("storage",{xmlns:"storage:bookmarks"});b.eachChild(function(h){this.c("conference",{name:h.attributes.alias,anonymous:h.attributes.anonymous?"true":"false",autojoin:h.attributes.autojoin?"true":"false",jid:h.attributes.jid}).c("nick",h.attributes.handle).up().up()},f);Application.XMPPConn.sendIQ(f.tree())}
function onPresenceCheck(b,f){"available"==b.xmpp?Application.XMPPConn.send($pres()):Application.XMPPConn.send($pres().c("show","away").up().c("status",b.xmpp));Ext.getCmp("presenceUI").setText(b.text)}
Application.Control={region:"west",title:"Weather.IM Live",collapsible:!0,width:200,split:!0,layout:"accordion",layoutConfig:{autoWidth:!1},autoScroll:!0,tbar:[{text:"Actions",menu:[{checked:!1,text:"Show Offline Buddies",checkHandler:function(b,f){Ext.getCmp("buddies").root.cascade(function(h){f?h.ui.show():"offline"==h.attributes.presence&&h.ui.hide()})}},{xtype:"menuitem",text:"Chat with User",handler:function(){Application.CreatePrivateChat.show()}},{xtype:"menuitem",text:"Add Buddy...",handler:function(){Application.buildAddBuddy(null,
null,null)}},{xtype:"menuitem",text:"Join Group Chat",handler:function(){Application.JoinChatroomDialog.show()}},{text:"Msg Text Color",menu:{items:[new Ext.ColorPalette({id:"fgcolor",value:"000000",listeners:{select:function(b,f){Application.setPreference("fgcolor",f)}}})]}},{text:"Msg Background Color",menu:{items:[new Ext.ColorPalette({id:"bgcolor",value:"FFFFFF",listeners:{select:function(b,f){Application.setPreference("bgcolor",f)}}})]}},{xtype:"menuitem",text:"Show Debug Window",handler:function(){Ext.getCmp("debug").show()}},
{xtype:"menuitem",text:"Log Out",handler:function(){Application.log("Manual logout requested.");Application.RECONNECT=!1;Application.XMPPConn.disconnect()}}]},{xtype:"tbseparator"},{text:"Available",id:"presenceUI",menu:{items:[{text:"Available",xmpp:"available",checked:!0,group:"presence",checkHandler:onPresenceCheck},{text:"Be Right Back",xmpp:"Be Right Back",checked:!1,group:"presence",checkHandler:onPresenceCheck},{text:"Away",xmpp:"away",checked:!1,group:"presence",checkHandler:onPresenceCheck}]}},
{xtype:"splitbutton",id:"sound",scale:"medium",soundOn:!0,handler:function(b){b.soundOn?(b.setIcon("icons/mute.png"),soundManager.muteAll(),b.soundOn=!1):(b.setIcon("icons/volume.png"),soundManager.unmuteAll(),b.soundOn=!0,Application.MsgBus.fireEvent("soundevent","default"))},arrowHandler:function(){Application.soundPrefs.show()},icon:"icons/volume.png"}],items:[{flex:1,xtype:"treepanel",id:"buddies",title:"Buddies",collapsed:!1,rootVisible:!1,lines:!1,autoScroll:!0,containerScroll:!0,plugins:new Ext.ux.DataTip({tpl:new Ext.XTemplate('<tpl if="typeof(resources) !== &quot;undefined&quot;">',
"<div>",'<tpl for="resources.items">',"<p><b>Resource:</b> {resource} <b>Status:</b> {status}</p>","</tpl>","</div>","</tpl>")}),listeners:{click:function(b){(cp=Ext.getCmp("chatpanel").getChat(b.attributes.barejid))||(cp=Ext.getCmp("chatpanel").addChat(b.attributes.barejid));Ext.getCmp("chatpanel").setActiveTab(cp)}},root:new Ext.tree.TreeNode},{flex:1,xtype:"treepanel",id:"bookmarks",title:"Chatroom Bookmarks",collapsed:!1,rootVisible:!1,enableDD:!0,lines:!1,containerScroll:!0,autoScroll:!0,plugins:new Ext.ux.DataTip({tpl:"<div>Anonymous: {anonymous}<br />Autojoin: {autojoin}</div>"}),
contextMenu:new Ext.menu.Menu({items:[{id:"delete-node",icon:"icons/close.png",text:"Delete Bookmark"}],listeners:{itemclick:function(b){var f=b.parentMenu.contextNode;switch(b.id){case "delete-node":f.parentNode&&(f.remove(),saveBookmarks())}}}}),listeners:{contextmenu:function(b,f){b.select();var h=b.getOwnerTree().contextMenu;h.contextNode=b;h.showAt(f.getXY())},movenode:function(b,f,h,q,u){saveBookmarks()},click:function(b){Application.JoinChatroomDialog.show(null,function(){form=this.items.items[0].getForm();
form.findField("roomname").setValue(Strophe.getNodeFromJid(b.attributes.jid));form.findField("roomhandle").setValue(b.attributes.handle);form.findField("bookmark").enable();form.findField("anonymous").setValue(b.attributes.anonymous);form.findField("autojoin").setValue(b.attributes.autojoin);form.findField("roomalias").setValue(b.attributes.alias)})}},root:new Ext.tree.TreeNode({initialLoad:!1,listeners:{beforeappend:function(b,f,h,q){if(b=f.findChild("jid",h.attributes.jid))Application.log("Replacing MUC bookmark: "+
h.attributes.jid),f.removeChild(b,!0);return!0},append:function(b,f,h,q){f.initialLoad&&saveBookmarks()}}})},{flex:2,xtype:"treepanel",id:"chatrooms",title:"Chatrooms",collapsed:!1,rootVisible:!1,lines:!1,autoScroll:!0,containerScroll:!0,listeners:{click:function(b){Application.JoinChatroomDialog.show(null,function(){form=this.items.items[0].getForm();form.findField("roomname").setValue(Strophe.getNodeFromJid(b.attributes.jid));form.findField("roomhandle").setValue(Application.USERNAME);form.findField("bookmark").enable();
form.findField("anonymous").setValue(!1);form.findField("autojoin").setValue(!1);form.findField("roomalias").setValue(Strophe.getNodeFromJid(b.attributes.jid))})}},root:new Ext.tree.TreeNode}]};
Application.doLogin=function(){Application.RECONNECT=!0;Application.ATTEMPTS+=1;11<Application.ATTEMPTS?Application.log("Application Login Limit Reached!"):(username=Ext.getCmp("username").getValue(),0<username.indexOf("@")&&(username=Strophe.getNodeFromJid(username)),username=username.toLowerCase(),username=username.replace(/^\s+|\s+$/g,""),password=Ext.getCmp("password").getValue(),""==username?Application.log("Invalid Username"):""==password?Application.log("Invalid Password"):Application.login(username,
password))};Ext.ns("Application");Application.ServiceGuard={skipFirst:!0,run:function(){this.skipFirst?this.skipFirst=!1:Application.XMPPConn&&Application.XMPPConn.authenticated&&0!=Application.XMPPConn.errors&&Application.log("Strophe error counter is non-zero: "+Application.XMPPConn.errors)},interval:12E4};function UTCStringToDate(b,f){b=Date.parseDate(b,f);return void 0==b?"":b.fromUTC()}
function buildXMPP(){Application.log("Initializing XMPPConn Obj");Application.XMPPConn=new Strophe.Connection(Application.BOSH);Application.XMPPConn.disco.addFeature("http://jabber.org/protocol/chatstates");Application.DEBUGMODE&&(Application.XMPPConn.rawInput=rawInput,Application.XMPPConn.rawOutput=rawOutput)}
Application.login=function(b,f){jid=b+"@"+Application.XMPPHOST+"/"+Application.XMPPRESOURCE;"undefined"===typeof Application.XMPPConn&&buildXMPP();Application.XMPPConn.connect(jid,f,onConnect,60,1,Application.ROUTE)};Application.doAnonymousLogin=function(){"undefined"===typeof Application.XMPPConn&&buildXMPP();Application.XMPPConn.connect(Application.XMPPHOST,null,onConnect)};
Application.register=function(){"undefined"===typeof Application.XMPPConn&&buildXMPP();Application.XMPPConn.register.connect(Application.XMPPHOST,function(b){b===Strophe.Status.REGISTER?(Application.log("Strophe.Status.REGISTER"),Application.XMPPConn.register.fields.username=Ext.get("reguser").getValue(),Application.XMPPConn.register.fields.password=Ext.get("regpass").getValue(),Application.XMPPConn.register.fields.email=Ext.get("regemail").getValue(),Application.XMPPConn.register.submit()):b===Strophe.Status.REGISTERED?
(Ext.getCmp("loginpanel").addMessage("Username "+Application.XMPPConn.register.fields.username+" registered with server ..."),Ext.getCmp("loginwindow").items.items[0].activate(0),Ext.getCmp("username").setValue(Application.XMPPConn.register.fields.username),Ext.getCmp("password").setValue(Application.XMPPConn.register.fields.password),Application.XMPPConn.disconnect(),Application.doLogin()):b===Strophe.Status.CONFLICT?Application.log("Contact already existed!"):b===Strophe.Status.NOTACCEPTABLE?Application.log("Registration form not properly filled out."):
b===Strophe.Status.REGIFAIL?Application.log("The Server does not support In-Band Registration"):b===Strophe.Status.CONNECTED?(Application.log("connected?"),Application.USERNAME=Strophe.getNodeFromJid(Application.XMPPConn.jid)):Application.log(b)})};
function onConnect(b){if(b==Strophe.Status.CONNECTING)Application.log("Strophe.Status.CONNECTING...");else if(b==Strophe.Status.ERROR)Application.log("Strophe.Status.ERROR...");else if(b==Strophe.Status.AUTHFAIL)Application.log("Strophe.Status.AUTHFAIL..."),Application.RECONNECT=!1,Ext.getCmp("loginpanel").addMessage("Authentication failed, please check username and password..."),Application.XMPPConn.disconnect();else if(b==Strophe.Status.CONNFAIL)Application.log("Strophe.Status.CONNFAIL...");else if(b==
Strophe.Status.DISCONNECTED)Application.log("Strophe.Status.DISCONNECTED..."),Application.MsgBus.fireEvent("loggingout"),Application.RECONNECT?(Application.log("Relogging in after 3 seconds delay"),Application.doLogin.defer(3E3,this)):Application.MsgBus.fireEvent("loggedout");else if(b==Strophe.Status.AUTHENTICATING)Application.log("Strophe.Status.AUTHENTICATING...");else if(b==Strophe.Status.DISCONNECTING)Application.log("Strophe.Status.DISCONNECTING..."),Application.XMPPConn.flush();else if(b==
Strophe.Status.ATTACHED)Application.log("Strophe.Status.ATTACHED...");else if(b==Strophe.Status.CONNECTED){Application.log("Strophe.Status.CONNECTED...");Application.USERNAME=Strophe.getNodeFromJid(Application.XMPPConn.jid);Application.RECONNECT=!0;Application.XMPPConn.addHandler(onMessage,null,"message",null,null,null);Application.XMPPConn.addHandler(onPresence,null,"presence",null,null,null);Application.XMPPConn.addHandler(onRoster,Strophe.NS.ROSTER,"iq",null,null,null);Application.XMPPConn.addHandler(onIQ,
null,"iq",null,null,null);Application.XMPPConn.send($iq({type:"get"}).c("query",{xmlns:Strophe.NS.ROSTER}).tree());var f=0;Ext.getCmp("chatpanel").items.each(function(h){if("groupchat"==h.chatType){Application.log("Attempting to rejoin MUC: "+h.barejid);var q=$pres({to:h.barejid+"/"+h.handle});h.anonymous&&q.c("x",{xmlns:"http://jabber.org/protocol/muc#user"}).c("item").c("role","visitor");(function(){Application.XMPPConn.send(this.p)}).defer(5E3*f,{p:q});f+=1}});b=$iq({type:"get",id:"_get3"}).c("query",
{xmlns:"jabber:iq:private"}).c("storage",{xmlns:"nwschatlive:prefs"}).tree();Application.XMPPConn.sendIQ(b,parsePrefs);b=$iq({type:"get",id:"_get2"}).c("query",{xmlns:"jabber:iq:private"}).c("storage",{xmlns:"nwschatlive:views"}).tree();Application.XMPPConn.sendIQ(b,parseViews);Application.MsgBus.fireEvent("loggedin")}}
function updateMap(){var b=Application.getPreference("layers");if(null!=b){b=b.split("||");for(var f=0;f<b.length;f++)""!=b[f]&&(idx=Application.layerstore.find("title",b[f]),-1!=idx&&(Application.log("Setting Layer "+b[f]+" visable"),layer=Application.layerstore.getAt(idx).getLayer(),layer.setVisibility(!0)))}}
function setSounds(){Application.prefStore.each(function(b){key=b.get("key");"volume"==key?Ext.getCmp("volume").setValue(b.get("value")):0==key.indexOf("sound::")&&(tokens=key.split("::"),3==tokens.length&&(sidx=tokens[1],opt=tokens[2],store=Ext.getCmp("soundpanel").getStore(),idx=store.find("id",sidx),-1<idx&&(lrecord=store.getAt(idx),val=b.get("value"),"true"==val&&(val=!0),"false"==val&&(val=!1),lrecord.set(opt,val))))})}
function parsePrefs(b){Application.prefStore.removeAll();b=$(b).find("pref");for(var f=0;f<b.length;f++)key=b[f].getAttribute("key"),value=b[f].getAttribute("value"),Application.setPreference(key,value);Application.prefStore.locked=!0;setSounds();try{var h=parseInt(Application.getPreference("font-size",14))+2;cssfmt=String.format("normal {0}px arial",h);Ext.util.CSS.updateRule("td.x-grid3-td-message","font",cssfmt);Ext.util.CSS.updateRule(".message-entry-box","font",cssfmt);updateMap();Application.updateColors()}catch(q){}Application.prefStore.locked=
!1}function parseViews(b){if(Ext.getCmp("map"))for(elem=$(b).find("view"),b=0;b<elem.length;b++)label=elem[b].getAttribute("label"),bounds=elem[b].getAttribute("bounds"),""!=label&&(Ext.getCmp("mfv"+(b+1)).setValue(label),Ext.getCmp("fm"+(b+1)).setText(label)),Ext.getCmp("mfv"+(b+1)).bounds=OpenLayers.Bounds.fromArray(bounds.split(",")),0==b&&Ext.getCmp("map").map.zoomToExtent(OpenLayers.Bounds.fromArray(bounds.split(",")),!0)}
function parseBookmarks(b){elem=$(b).find("conference");for(var f=b=0;f<elem.length;f++){alias=elem[f].getAttribute("name");jid=elem[f].getAttribute("jid");nick=$(elem[f]).find("nick").text();if(null==nick||""==nick)nick=Application.USERNAME;anonymous="true"==elem[f].getAttribute("anonymous");autojoin="true"==elem[f].getAttribute("autojoin");Ext.getCmp("bookmarks").root.appendChild({text:alias+" ("+Strophe.getNodeFromJid(jid)+")",jid,alias,autojoin,iconCls:"chatroom-icon",handle:nick,anonymous,leaf:!0});
autojoin&&null==Ext.getCmp("chatpanel").getMUC(jid)&&(Application.log("Autojoining MUC: "+jid),function(){Application.MsgBus.fireEvent("joinchat",this.jid,this.nick,this.anonymous)}.defer(5E3*b,{jid,nick,anonymous}),b+=1)}Ext.getCmp("bookmarks").root.initialLoad=!0}function onIQ(b){try{iqParser(b)}catch(h){b="IQ Bug\n:"+(Strophe.xmlescape(Strophe.serialize(b))+"\n");for(var f in h)b+="property: "+f+" value: ["+h[f]+"]\n";b+="toString():  value: ["+h.toString()+"]";Application.log(b)}return!0}
function iqParser(b){if("fetchrooms"==b.getAttribute("id")){items=b.firstChild.getElementsByTagName("item");for(b=0;b<items.length;b++)Ext.getCmp("chatrooms").root.appendChild({text:items[b].getAttribute("name")+" ("+Strophe.getNodeFromJid(items[b].getAttribute("jid"))+")",jid:items[b].getAttribute("jid"),iconCls:"chatroom-icon",leaf:!0});myTreeSorter=new Ext.tree.TreeSorter(Ext.getCmp("chatrooms"),{folderSort:!0,dir:"asc"});myTreeSorter.doSort(Ext.getCmp("chatrooms").getRootNode())}}
function onRoster(b){try{rosterParser(b)}catch(h){b="Roster Bug\n:"+(Strophe.xmlescape(Strophe.serialize(b))+"\n");for(var f in h)b+="property: "+f+" value: ["+h[f]+"]\n";b+="toString():  value: ["+h.toString()+"]";Application.log(b)}return!0}
function rosterParser(b){var f=Ext.getCmp("buddies").root;b=$(b).find("item");for(var h=0;h<b.length;h++)for(var q=$(b[h]).find("group"),u=0;u<q.length;u++){var v=$(q[u]);child=f.findChild("group",v.text())||f.appendChild({leaf:!1,group:v.text(),text:v.text(),expanded:!0,loaded:!0});child.appendChild({text:b[h].getAttribute("name"),barejid:b[h].getAttribute("jid"),resources:new Ext.util.MixedCollection,iconCls:"buddy-offline",presence:"offline",hidden:!0,leaf:!0})}Application.XMPPConn.send($pres().tree());
var x=$iq({type:"get",id:"_get1"}).c("query",{xmlns:"jabber:iq:private"}).c("storage",{xmlns:"storage:bookmarks"}).tree();(function(){Application.XMPPConn.sendIQ(x,parseBookmarks)}).defer(3E3,this);return!0}function onPresence(b){try{presenceParser(b)}catch(h){b="Presence Bug\n:"+(Strophe.xmlescape(Strophe.serialize(b))+"\n");for(var f in h)b+="property: "+f+" value: ["+h[f]+"]\n";b+="toString():  value: ["+h.toString()+"]";Application.log(b)}return!0}
function getMUCIcon(b,f){return"owner"==b?"icons/owner.png":"admin"==b?"icons/admin.png":"icons/participant.png"}
function presenceParser(b){var f=b.getAttribute("from");if(Strophe.getDomainFromJid(f)=="conference."+Application.XMPPHOST)if(room=Strophe.getBareJidFromJid(f),mcp=Ext.getCmp("chatpanel").getMUC(room),null==mcp)Application.log("ERROR: got presence from non-existant room: "+room);else{if(0<$(b).find("status").length&&(error=$(b).find("status"),"201"==error[0].getAttribute("code"))){Ext.Msg.alert("Status","Sorry, chatroom ["+room+"] does not exist.");Ext.getCmp("chatpanel").removeMUC(room);return}if(0<
$(b).find("error").length&&(error=$(b).find("error"),"407"==error[0].getAttribute("code"))){Ext.Msg.alert("Status","Sorry, your account is not authorized to access chatroom ["+room+"]");Ext.getCmp("chatpanel").removeMUC(room);return}if(0<$(b).find("error").length&&(error=$(b).find("error"),"409"==error[0].getAttribute("code"))){Ext.Msg.alert("Status","Sorry, your requested chatroom handle is already in use by room ["+room+"]");Ext.getCmp("chatpanel").removeMUC(room);return}if(0<$(b).find("status").length&&
(error=$(b).find("status"),"307"==error[0].getAttribute("code"))){Ext.Msg.alert("Status","Your account signed into this chatroom ["+room+"] with the same handle from another location. Please use unique handles.");mcp.joinedChat=!1;Ext.getCmp("chatpanel").removeMUC(room);return}child=mcp.roomusers.root.findChild("text",Strophe.getResourceFromJid(f));var h=$(b).find("item"),q=f;if(0<h.length){q=h[0].getAttribute("jid")||q;var u=h[0].getAttribute("role");var v=h[0].getAttribute("affiliation");h=$(h[0]).find("role");
if(0<h.length)try{u=h.text()}catch(y){h="roletest bug\n:"+(Strophe.xmlescape(Strophe.serialize(b))+"\n");for(var x in y)h+="property: "+x+" value: ["+y[x]+"]\n";h+="toString():  value: ["+y.toString()+"]";Application.log(h)}}null!=b.getAttribute("type")||child||"visitor"==u||(mcp.joinedChat=!0,mcp.roomusers.root.appendChild({affiliation:v,role:u,icon:getMUCIcon(v,u),text:Strophe.getResourceFromJid(f),jid:q,leaf:!0}));"unavailable"==b.getAttribute("type")&&child&&mcp.roomusers.root.removeChild(child)}else onBuddyPresence(b)}
function onMessage(b){try{messageParser(b)}catch(h){b="Message Bug\n:"+(Strophe.xmlescape(Strophe.serialize(b))+"\n");for(var f in h)b+="property: "+f+" value: ["+h[f]+"]\n";b+="toString():  value: ["+h.toString()+"]";Application.log(b)}return!0}Application.replaceURLWithHTMLLinks=function(b){return null==b?null:b.replace(/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig,"<a href='$1'>$1</a>")};
function messageParser(b){var f=b.getAttribute("from"),h=b.getAttribute("type"),q=b.getElementsByTagName("body"),u=$(b).find("delay[xmlns='urn:xmpp:delay']"),v=$(b).find("html"),x=q[0];q=!1;0<v.length?(v=$(b).find("html").find("body"),v=navigator.userAgent.match(/msie/i)?v[0].xml:$(v[0]).html(),v=v.replace(/<p/g,"<span").replace(/<\/p>/g,"</span>"),""==v&&(Application.log("Message Failure:"+b),v=Application.replaceURLWithHTMLLinks(Strophe.getText(x)))):v=Application.replaceURLWithHTMLLinks(Strophe.getText(x));
0<u.length?(x=UTCStringToDate(u[0].getAttribute("stamp").substring(0,19),"Y-m-d\\Th:i:s"),q=!0):x=new Date;if("groupchat"==h){product_id=null;u=$(b).find("x");for(h=0;h<u.length;h++)u[h].getAttribute("product_id")&&(product_id=u[h].getAttribute("product_id"));try{geomParser(b,q)}catch(y){}sender=Strophe.getResourceFromJid(f);room=Strophe.getBareJidFromJid(f);(mpc=Ext.getCmp("chatpanel").getMUC(room))&&sender&&(mpc.gp.getStore().addSorted(new Ext.data.Record({ts:x,author:sender,message:v,room:null,
jid:mpc.getJidByHandle(sender),xdelay:q,product_id})),mpc.gp.getStore().isFiltered()&&mpc.gp.getStore().filterBy(nwsbotFilter),q||(Ext.getCmp("__allchats__").gp.getStore().addSorted(new Ext.data.Record({ts:x,author:sender,room:Strophe.getNodeFromJid(f),message:v,jid:mpc.getJidByHandle(sender),xdelay:q,product_id})),Ext.getCmp("__allchats__").gp.getStore().isFiltered()&&Ext.getCmp("__allchats__").gp.getStore().filterBy(nwsbotFilter)))}else"chat"!=h||v||null==f?"chat"==h&&v&&null!=f?(jid=Strophe.getBareJidFromJid(f),
username=Strophe.getNodeFromJid(f),Strophe.getDomainFromJid(f)!=Application.XMPPHOST&&(jid=f,username=Strophe.getResourceFromJid(f)),cp=Ext.getCmp("chatpanel").getChat(jid),cp||(cp=Ext.getCmp("chatpanel").addChat(jid),Application.MsgBus.fireEvent("soundevent","new_conversation")),cp.gp.store.addSorted(new Ext.data.Record({ts:x,author:username,room:null,xdelay:!1,message:v}))):f==Application.XMPPHOST&&(new Ext.Window({width:500,maxWidth:500,height:350,constrain:!0,autoScroll:!0,bodyStyle:{padding:"10",
background:"#fff"},title:$(b).find("subject").text()||"System Message",html:"<p><b>System Message</b><p>"+$(b).find("body").text()+"</p>"})).show():(jid=Strophe.getBareJidFromJid(f),cp=Ext.getCmp("chatpanel").getChat(jid),0<$(b).find("composing").length&&cp&&cp.setIconCls("typing-tab"),0<$(b).find("paused").length&&cp&&cp.setIconCls("paused-tab"))}
function geomParser(b,f){if(Ext.getCmp("map")){var h=b.getElementsByTagName("body")[0],q=null;0<b.getElementsByTagName("html").length?(q=$(b).find("html").find("body"),q=navigator.userAgent.match(/msie/i)?q[0].xml:$(q[0]).html()):q=Strophe.getText(h);b=$(b).find("x");if(0!=b.length)for(h=0;h<b.length;h++)if(null!=b[h].getAttribute("geometry")){var u=b[h].getAttribute("geometry");wkt=new OpenLayers.Format.WKT;if(collection=wkt.read(u)){collection.constructor!=Array&&(collection=[collection]);var v=
collection[0];u=36E5;if(!b[h].getAttribute("skip")){if(b[h].getAttribute("expire")){var x=UTCStringToDate(b[h].getAttribute("expire"),"Ymd\\Th:i:s");v.attributes.expire=x.toUTC();diff=x-new Date;if(0>=diff)continue;0<diff&&(u=diff)}b[h].getAttribute("valid")&&(x=UTCStringToDate(b[h].getAttribute("valid"),"Ymd\\Th:i:s"),v.attributes.valid=x.toUTC());v.attributes.ptype=b[h].getAttribute("ptype");v.attributes.message=q;v.geometry.transform(new OpenLayers.Projection("EPSG:4326"),new OpenLayers.Projection("EPSG:900913"));
"LSR"!=b[h].getAttribute("category")&&"PIREP"!=b[h].getAttribute("category")||!v.attributes.valid||f&&!(f&&72E5>new Date-v.attributes.valid)||(lsrs.addFeatures([v]),(new Ext.util.DelayedTask(function(){lsrs.removeFeatures([v])})).delay(u),sstate=Application.lsrStore.getSortState(),Application.lsrStore.sort(sstate.field,sstate.direction));"SBW"==b[h].getAttribute("category")&&(v.attributes.vtec=b[h].getAttribute("vtec"),x=Application.sbwStore.find("vtec",v.attributes.vtec),"CAN"==b[h].getAttribute("status")?
-1<x&&(Application.log("Removing SBW vtec ["+v.attributes.vtec+"]"),Application.sbwStore.removeAt(x)):(-1<x&&(Application.log("Old SBW vtec ["+v.attributes.vtec+"]"),Application.sbwStore.removeAt(x)),Application.log("Adding SBW vtec ["+v.attributes.vtec+"] delay ["+u+"]"),sbws.addFeatures([v]),(new Ext.util.DelayedTask(function(){sbws.removeFeatures([v])})).delay(u),sstate=Application.sbwStore.getSortState(),Application.sbwStore.sort(sstate.field,sstate.direction)))}}}}}
function rawInput(b){Application.log("RECV: "+Strophe.xmlescape(b))}function rawOutput(b){Application.log("SENT: "+Strophe.xmlescape(b))};Ext.ns("Application");Application.updateColors=function(){var b=Application.getPreference("bgcolor","FFFFFF"),f=Application.getPreference("fgcolor","000000");Application.log("Attempting style adjustment bgcolor:"+b+", fgcolor:"+f);Ext.getCmp("chatpanel").items.each(function(h){h.te&&h.te.items.get(0).getEl().applyStyles({background:"#"+b,color:"#"+f})})};
Application.syncPreferences=function(){Application.log("Saving preferences to server...");var b=$iq({type:"set",id:"_set1"}).c("query",{xmlns:"jabber:iq:private"}).c("storage",{xmlns:"nwschatlive:prefs"});Application.prefStore.each(function(f){this.c("pref",{key:f.get("key"),value:f.get("value")}).up()},b);void 0!==Application.XMPPConn&&Application.XMPPConn.sendIQ(b.tree())};Application.removePreference=function(b){idx=Application.prefStore.find("key",b);-1<idx&&Application.prefStore.removeAt(idx)};
Application.getPreference=function(b,f){idx=Application.prefStore.find("key",b);return-1<idx?(record=Application.prefStore.getAt(idx),record.get("value")):f};Application.setPreference=function(b,f){idx=Application.prefStore.find("key",b);-1<idx?(Application.log("Setting Preference: "+b+" Value: "+f),record=Application.prefStore.getAt(idx),record.set("value",f)):(Application.log("Adding Preference: "+b+" Value: "+f),Application.prefStore.add(new Ext.data.Record({key:b,value:f})))};
Application.prefStore=new Ext.data.Store({fields:[{id:"key"},{id:"value"}],locked:!1,listeners:{remove:function(b,f,h){Application.log("prefStore remove event fired...");if(b.locked)return Application.log("Skipping preference save due to locking"),!0;Application.syncPreferences()},update:function(b,f,h){Application.log("prefStore update event fired...");if(b.locked)return Application.log("Skipping preference save due to locking"),!0;Application.syncPreferences();"fgcolor"!=f.get("key")&&"bgcolor"!=
f.get("key")||Application.updateColors()}}});Application.MsgBus=new Ext.util.Observable;Application.MsgBus.addEvents("message");Application.MsgBus.addEvents("loggedin");Application.MsgBus.addEvents("loggedout");
Application.playSound=function(b){if(soundManager&&soundManager.ok()&&1!=soundManager.playState){var f=soundManager.getSoundById(b);if(!f){idx=Application.SoundStore.find("id",b);if(-1==idx){Application.log("Could not find sound: "+b);return}record=Application.SoundStore.getAt(idx);f=soundManager.createSound({id:record.get("id"),url:record.get("src"),onplay:function(){},onfinish:function(){}})}f&&f.play({volume:Application.getPreference("volume",100)})}};
Application.MsgBus.on("soundevent",function(b){enable=Application.getPreference("sound::"+b+"::enabled","true");"false"!=enable&&(sidx=Application.getPreference("sound::"+b+"::sound","default"),Application.playSound(sidx))});
Application.MsgBus.on("loggingout",function(){Ext.getCmp("chatpanel").items.each(function(b){"groupchat"==b.chatType&&b.clearRoom()});Ext.getCmp("buddies").root.removeAll();Ext.getCmp("bookmarks").root.suspendEvents(!1);Ext.getCmp("bookmarks").root.removeAll();Ext.getCmp("bookmarks").root.resumeEvents();Ext.getCmp("bookmarks").root.initalLoad=!1;Ext.getCmp("chatrooms").root.removeAll()});Application.MsgBus.on("loggedout",function(){Ext.getCmp("loginwindow").show()});
Application.MsgBus.on("loggedin",function(){Ext.getCmp("loginwindow").hide();Application.XMPPConn.send($iq({type:"get",id:"fetchrooms",to:"conference."+Application.XMPPHOST}).c("query",{xmlns:"http://jabber.org/protocol/disco#items"}))});
Application.MsgBus.on("joinchat",function(b,f,h){if(null==f||""==f)f=Application.USERNAME;mcp=Ext.getCmp("chatpanel").getMUC(b);if(null==mcp){Application.log("Creating chatroom:"+b);mcp=Ext.getCmp("chatpanel").addMUC(b,f,h);var q=$pres({to:b+"/"+f});h&&q.c("x",{xmlns:"http://jabber.org/protocol/muc#user"}).c("item").c("role","visitor");Application.XMPPConn.send(q);mcp.on("destroy",function(){Application.XMPPConn.authenticated&&this.joinedChat&&Application.XMPPConn.send($pres({type:"unavailable",to:b+
"/"+f}))})}Ext.getCmp("chatpanel").setActiveTab(mcp)});Ext.ns("Application");
Application.buildAddBuddy=function(b,f,h){Ext.getCmp("addbuddy")||(new Ext.Window({title:"Add Buddy",layout:"form",width:300,height:150,id:"addbuddy",items:[{xtype:"textfield",fieldLabel:"Weather.IM ID",value:b},{xtype:"textfield",fieldLabel:"Alias",value:f},{xtype:"textfield",fieldLabel:"Buddy Group",value:h}],buttons:[{text:"Add Buddy",handler:function(q){var u=q.ownerCt.ownerCt.items.items[0].getValue(),v=q.ownerCt.ownerCt.items.items[1].getValue();q=q.ownerCt.ownerCt.items.items[2].getValue();var x=
$pres({to:u+"@"+Application.XMPPHOST,type:"subscribe"});Application.XMPPConn.send(x.tree());x=$iq({type:"set"}).c("query",{xmlns:"jabber:iq:roster"}).c("item",{jid:u+"@"+Application.XMPPHOST,name:v}).c("group",q);Application.XMPPConn.send(x.tree());Ext.getCmp("addbuddy").close()}}]})).show()};
